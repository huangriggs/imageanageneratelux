<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECF å…è²»åœ–åƒè§£æèˆ‡ç”Ÿæˆå™¨ - æ·±è‰²ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            overflow-x: auto;
            color: #e2e8f0;
        }

        .container {
            width: 100%;
            max-width: 1920px;
            margin: 0 auto;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
        }

        .header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%);
            color: #f1f5f9;
            padding: 25px 40px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 8px;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.5);
            color: #f1f5f9;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.85;
            color: #cbd5e1;
        }

        .main-content {
            display: flex;
            flex: 1;
            min-height: calc(100vh - 120px);
        }

        /* å·¦å´é¢æ¿ */
        .left-panel {
            width: 400px;
            background: linear-gradient(180deg, #1e293b 0%, #334155 100%);
            padding: 25px;
            border-right: 1px solid rgba(148, 163, 184, 0.15);
            overflow-y: auto;
            height: calc(100vh - 120px);
            position: sticky;
            top: 120px;
            backdrop-filter: blur(10px);
        }

        /* ä¸­é–“ä¸»è¦å€åŸŸ */
        .center-panel {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
        }

        /* å³å´é¢æ¿ */
        .right-panel {
            width: 450px;
            background: linear-gradient(180deg, #1e293b 0%, #334155 100%);
            padding: 25px;
            border-left: 1px solid rgba(148, 163, 184, 0.15);
            overflow-y: auto;
            height: calc(100vh - 120px);
            position: sticky;
            top: 120px;
            backdrop-filter: blur(10px);
        }

        .panel-section {
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(148, 163, 184, 0.1);
            backdrop-filter: blur(20px);
            transition: all 0.3s ease;
        }

        .panel-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        .panel-section h3 {
            color: #60a5fa;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* åœ–åƒä¸Šå‚³å€åŸŸ */
        .image-upload-area {
            border: 2px dashed #60a5fa;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.4), rgba(51, 65, 85, 0.4));
            transition: all 0.4s ease;
            cursor: pointer;
            margin: 25px 0;
            position: relative;
            overflow: hidden;
            min-height: 320px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .image-upload-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(96, 165, 250, 0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .image-upload-area:hover {
            border-color: #34d399;
            background: linear-gradient(135deg, rgba(52, 211, 153, 0.1), rgba(96, 165, 250, 0.1));
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(96, 165, 250, 0.2);
        }

        .image-upload-area:hover::before {
            opacity: 1;
        }

        .image-upload-area.dragover {
            border-color: #34d399;
            background: linear-gradient(135deg, rgba(52, 211, 153, 0.2), rgba(96, 165, 250, 0.2));
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .uploaded-image-preview {
            max-width: 100%;
            max-height: 280px;
            border-radius: 15px;
            margin: 15px auto;
            display: block;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
            transition: transform 0.3s ease;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .uploaded-image-preview:hover {
            transform: scale(1.05);
        }

        .control-btn {
            padding: 10px 18px;
            border: 2px solid #60a5fa;
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(51, 65, 85, 0.8));
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            color: #60a5fa;
            transition: all 0.3s ease;
            margin: 5px;
            box-shadow: 0 4px 15px rgba(96, 165, 250, 0.2);
            backdrop-filter: blur(10px);
        }

        .control-btn:hover {
            background: linear-gradient(135deg, #60a5fa, #34d399);
            color: #0f172a;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(96, 165, 250, 0.4);
            border-color: transparent;
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* çµæœé¡¯ç¤ºå€åŸŸ */
        .results-area {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.6), rgba(51, 65, 85, 0.6));
            border-radius: 20px;
            padding: 25px;
            margin: 25px 0;
            border: 1px solid rgba(52, 211, 153, 0.3);
            display: none;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .result-item {
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 15px;
            border: 1px solid rgba(148, 163, 184, 0.1);
            backdrop-filter: blur(10px);
        }

        .result-label {
            font-weight: 700;
            color: #34d399;
            margin-bottom: 12px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .result-content {
            color: #cbd5e1;
            font-size: 0.95rem;
            line-height: 1.6;
            background: rgba(15, 23, 42, 0.8);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.1);
            backdrop-filter: blur(10px);
        }

        /* è¼¸å…¥æ¡†æ¨£å¼ */
        .input-field {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(148, 163, 184, 0.2);
            border-radius: 15px;
            font-size: 0.95rem;
            background: rgba(15, 23, 42, 0.8);
            color: #e2e8f0;
            transition: all 0.3s ease;
            margin-bottom: 12px;
            backdrop-filter: blur(10px);
        }

        .input-field:focus {
            border-color: #60a5fa;
            outline: none;
            box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.2);
            background: rgba(30, 41, 59, 0.9);
        }

        .input-field::placeholder {
            color: #64748b;
        }

        .textarea-field {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(148, 163, 184, 0.2);
            border-radius: 15px;
            font-size: 0.95rem;
            background: rgba(15, 23, 42, 0.8);
            color: #e2e8f0;
            resize: vertical;
            min-height: 100px;
            transition: all 0.3s ease;
            margin-bottom: 12px;
            backdrop-filter: blur(10px);
        }

        .textarea-field:focus {
            border-color: #60a5fa;
            outline: none;
            box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.2);
            background: rgba(30, 41, 59, 0.9);
        }

        .textarea-field::placeholder {
            color: #64748b;
        }

        /* è¨­å®šç¶²æ ¼ */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .setting-item {
            display: flex;
            flex-direction: column;
        }

        .setting-item label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #cbd5e1;
            font-size: 0.95rem;
        }

        .setting-item input, .setting-item select {
            padding: 12px;
            border: 2px solid rgba(148, 163, 184, 0.2);
            border-radius: 12px;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            background: rgba(15, 23, 42, 0.8);
            color: #e2e8f0;
            backdrop-filter: blur(10px);
        }

        .setting-item input:focus, .setting-item select:focus {
            border-color: #60a5fa;
            outline: none;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
        }

        .setting-item select option {
            background: #1e293b;
            color: #e2e8f0;
        }

        /* å¹³å°é¸æ“‡å™¨ */
        .platform-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .platform-option {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid rgba(148, 163, 184, 0.2);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(15, 23, 42, 0.6);
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
        }

        .platform-option.selected {
            border-color: #60a5fa;
            background: rgba(96, 165, 250, 0.1);
            box-shadow: 0 0 20px rgba(96, 165, 250, 0.2);
        }

        .platform-option:hover {
            border-color: #34d399;
            background: rgba(52, 211, 153, 0.1);
            transform: translateY(-1px);
        }

        .platform-option input[type="radio"] {
            margin-right: 12px;
            accent-color: #60a5fa;
        }

        .platform-option.gemini {
            border-color: #a855f7;
        }

        .platform-option.gemini.selected {
            border-color: #a855f7;
            background: rgba(168, 85, 247, 0.1);
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.2);
        }

        .platform-option.gemini:hover {
            border-color: #c084fc;
            background: rgba(196, 132, 252, 0.1);
        }

        /* ç”ŸæˆæŒ‰éˆ• */
        .generate-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #a855f7 0%, #ec4899 25%, #f59e0b 50%, #10b981 75%, #06b6d4 100%);
            color: #ffffff;
            border: none;
            border-radius: 30px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 25px 0;
            box-shadow: 0 8px 30px rgba(168, 85, 247, 0.3);
            position: relative;
            overflow: hidden;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .generate-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .generate-btn:hover::before {
            left: 100%;
        }

        .generate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(168, 85, 247, 0.4);
            background: linear-gradient(135deg, #9333ea 0%, #db2777 25%, #d97706 50%, #059669 75%, #0284c7 100%);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* è¼‰å…¥å‹•ç•« */
        .loading {
            display: none;
            text-align: center;
            margin: 25px 0;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(96, 165, 250, 0.2);
            border-top: 4px solid #60a5fa;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* åœ–åƒçµæœå±•ç¤º */
        .image-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            margin: 25px 0;
        }

        .image-result-item {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            border: 1px solid rgba(148, 163, 184, 0.1);
            backdrop-filter: blur(20px);
            transition: transform 0.3s ease;
        }

        .image-result-item:hover {
            transform: translateY(-5px);
        }

        .preview-image {
            max-width: 100%;
            max-height: 280px;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            margin-bottom: 15px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            transition: transform 0.3s ease;
        }

        .preview-image:hover {
            transform: scale(1.05);
        }

        .download-btn {
            margin: 5px;
            padding: 10px 18px;
            background: linear-gradient(135deg, #34d399, #10b981);
            color: #0f172a;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            box-shadow: 0 4px 15px rgba(52, 211, 153, 0.3);
        }

        .download-btn:hover {
            background: linear-gradient(135deg, #10b981, #059669);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 211, 153, 0.4);
        }

        /* æ‘ºç–Šé¢æ¿ */
        .collapsible-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: color 0.3s ease;
        }

        .collapsible-header:hover {
            color: #34d399;
        }

        .collapsible-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            padding: 0;
            margin: 0;
        }

        /* æ¨¡æ¿æŒ‰éˆ• */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .template-btn {
            padding: 8px 15px;
            border: 2px solid rgba(148, 163, 184, 0.3);
            background: rgba(15, 23, 42, 0.8);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            color: #cbd5e1;
            transition: all 0.3s ease;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .template-btn:hover {
            border-color: #60a5fa;
            background: rgba(96, 165, 250, 0.1);
            color: #60a5fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(96, 165, 250, 0.2);
        }

        /* æ­·å²è¨˜éŒ„ */
        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 20px;
        }

        .history-item {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
            border: 1px solid rgba(148, 163, 184, 0.1);
            backdrop-filter: blur(20px);
        }

        .history-item:hover {
            transform: translateY(-5px);
        }

        .history-image {
            width: 100%;
            height: 140px;
            object-fit: cover;
        }

        .history-info {
            padding: 12px;
        }

        .history-prompt {
            font-size: 0.8rem;
            color: #cbd5e1;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .history-date {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 10px;
        }

        .history-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .history-btn {
            padding: 5px 10px;
            border: 1px solid rgba(148, 163, 184, 0.3);
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s ease;
            color: #cbd5e1;
            backdrop-filter: blur(10px);
        }

        .history-btn:hover {
            background: rgba(96, 165, 250, 0.2);
            border-color: #60a5fa;
            color: #60a5fa;
        }

        /* API ç‹€æ…‹ */
        .api-status {
            position: fixed;
            top: 25px;
            right: 25px;
            padding: 12px 20px;
            border-radius: 30px;
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .api-status.connected {
            background: linear-gradient(135deg, #10b981, #059669);
            color: #f0fdf4;
        }

        .api-status.connecting {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: #fffbeb;
        }

        .api-status.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: #fef2f2;
        }

        /* è¨Šæ¯æç¤º */
        .info-box {
            background: rgba(59, 130, 246, 0.1);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(59, 130, 246, 0.3);
            font-size: 0.9rem;
            color: #93c5fd;
            backdrop-filter: blur(10px);
        }

        .warning-box {
            background: rgba(245, 158, 11, 0.1);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(245, 158, 11, 0.3);
            font-size: 0.9rem;
            color: #fbbf24;
            backdrop-filter: blur(10px);
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 1400px) {
            .right-panel {
                width: 380px;
            }
            .left-panel {
                width: 380px;
            }
        }

        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
            }
            
            .left-panel, .right-panel {
                width: 100%;
                height: auto;
                position: static;
            }
            
            .center-panel {
                order: 1;
            }
            
            .left-panel {
                order: 2;
            }
            
            .right-panel {
                order: 3;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 20px 25px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .left-panel, .center-panel, .right-panel {
                padding: 20px;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .template-grid {
                grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            }
        }

        .error, .success {
            padding: 18px;
            border-radius: 12px;
            margin: 20px 0;
            display: none;
            font-weight: 600;
            font-size: 0.95rem;
            backdrop-filter: blur(20px);
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .success {
            background: rgba(34, 197, 94, 0.1);
            color: #86efac;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        /* æ»¾å‹•æ¢æ¨£å¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.3);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(96, 165, 250, 0.5);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(96, 165, 250, 0.7);
        }

        /* ç»ç’ƒæ•ˆæœ */
        .glass-effect {
            background: rgba(30, 41, 59, 0.3);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– ECF Premium å…è²»åœ–åƒè§£æèˆ‡ç”Ÿæˆå™¨</h1>
            <p>æ™ºèƒ½æ‹ç…§åœ–åƒè­˜åˆ¥ + AI æ•…äº‹ç”Ÿæˆ + åœ–åƒå‰µä½œ (æ”¯æ´ Gemini 2.0)</p>
        </div>
        
        <div class="main-content">
            <!-- å·¦å´é¢æ¿ï¼šè¨­å®šèˆ‡å·¥å…· -->
            <div class="left-panel">
                <!-- API è¨­å®š -->
                <div class="panel-section">
                    <div class="collapsible-header" onclick="toggleSection('apiConfig')">
                        <h3>ğŸ”‘ Gemini API è¨­å®š</h3>
                        <span id="apiConfigToggle">â–¼</span>
                    </div>
                    <div id="apiConfigContent" class="collapsible-content">
                        <div class="info-box">
                            ğŸ” æ‚¨çš„ API Key åƒ…ä¿å­˜åœ¨ç€è¦½å™¨æœ¬åœ°ï¼Œä¸æœƒä¸Šå‚³åˆ°ä»»ä½•æœå‹™å™¨ã€‚åŒæ™‚æ”¯æ´åœ–åƒè§£æèˆ‡ Gemini 2.0 åœ–åƒç”Ÿæˆã€‚
                        </div>
                        <input 
                            type="password" 
                            id="apiKey" 
                            class="input-field" 
                            placeholder="è«‹è¼¸å…¥æ‚¨çš„ Gemini API Key"
                            style="font-family: monospace; font-size: 0.85rem;"
                        >
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="control-btn" onclick="toggleApiKeyVisibility()">ğŸ‘ï¸ é¡¯ç¤º</button>
                            <button class="control-btn" onclick="testApiKey()">ğŸ” æ¸¬è©¦</button>
                            <button class="control-btn" onclick="clearApiKey()">ğŸ—‘ï¸ æ¸…ç©º</button>
                            <button class="control-btn" onclick="showApiKeyHelp()">â“ å¹«åŠ©</button>
                        </div>
                        <div id="apiKeyStatus" style="margin-top: 12px; padding: 10px; border-radius: 8px; display: none; font-size: 0.85rem;"></div>
                    </div>
                </div>

                <!-- å¹³å°é¸æ“‡ -->
                <div class="panel-section">
                    <h3>ğŸš€ AI ç”Ÿæˆå¹³å°</h3>
                    <div class="warning-box">
                        <strong>å¹³å°èªªæ˜ï¼š</strong><br>
                        â€¢ <span style="color: #60a5fa;">Pollinations</span>ï¼šFLUX æ¨¡å‹ï¼Œé€Ÿåº¦å¿«ï¼Œç©©å®šæ€§ä½³<br>
                        â€¢ <span style="color: #a855f7;">Gemini 2.0 å¢å¼·ç‰ˆ</span>ï¼šä½¿ç”¨ Gemini AI å„ªåŒ–æç¤ºè©ï¼Œæå‡åœ–åƒå“è³ª
                    </div>
                    <div class="platform-grid">
                        <label class="platform-option selected" for="pollinations">
                            <input type="radio" name="platform" value="pollinations" id="pollinations" checked>
                            <div>
                                <div style="font-weight: 600;">ğŸŒŸ Pollinations æ¨™æº–</div>
                                <div style="font-size: 0.8rem; color: #64748b;">å¿«é€Ÿç©©å®šï¼Œå…è²»ä½¿ç”¨</div>
                            </div>
                        </label>
                        
                        <label class="platform-option" for="pollinations_enhanced">
                            <input type="radio" name="platform" value="pollinations_enhanced" id="pollinations_enhanced">
                            <div>
                                <div style="font-weight: 600;">âš¡ Pollinations å¢å¼·</div>
                                <div style="font-size: 0.8rem; color: #64748b;">å•Ÿç”¨å¢å¼·åŠŸèƒ½</div>
                            </div>
                        </label>
                        
                        <label class="platform-option" for="pollinations_sdxl">
                            <input type="radio" name="platform" value="pollinations_sdxl" id="pollinations_sdxl">
                            <div>
                                <div style="font-weight: 600;">ğŸ¨ Pollinations SDXL</div>
                                <div style="font-size: 0.8rem; color: #64748b;">é«˜å“è³ªæ¸²æŸ“</div>
                            </div>
                        </label>
                        
                        <label class="platform-option gemini" for="gemini_25">
                            <input type="radio" name="platform" value="gemini_25" id="gemini_25">
                            <div>
                                <div style="font-weight: 600;">ğŸ§  Gemini 2.0 å¢å¼·ç‰ˆ</div>
                                <div style="font-size: 0.8rem; color: #64748b;">AI æ™ºèƒ½å„ªåŒ–æç¤ºè©ï¼Œéœ€ API Key</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- ç”Ÿæˆè¨­å®š -->
                <div class="panel-section">
                    <h3>âš™ï¸ ç”Ÿæˆè¨­å®š</h3>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label for="width">å¯¬åº¦</label>
                            <input type="number" id="width" value="1024" min="256" max="2048" step="64">
                        </div>
                        <div class="setting-item">
                            <label for="height">é«˜åº¦</label>
                            <input type="number" id="height" value="1024" min="256" max="2048" step="64">
                        </div>
                        <div class="setting-item">
                            <label for="seed">ç¨®å­å€¼</label>
                            <input type="number" id="seed" value="100" min="1" max="999999">
                        </div>
                        <div class="setting-item">
                            <label for="batchCount">æ‰¹é‡ç”Ÿæˆ</label>
                            <select id="batchCount">
                                <option value="1">å–®å¼µåœ–åƒ</option>
                                <option value="2">ç”Ÿæˆ 2 å¼µ</option>
                                <option value="4">ç”Ÿæˆ 4 å¼µ</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <label for="style">ğŸ¨ è—è¡“é¢¨æ ¼</label>
                        <select id="style">
                            <option value="">ç„¡ç‰¹å®šé¢¨æ ¼</option>
                            <optgroup label="ğŸ¬ å‹•ç•«é¢¨æ ¼">
                                <option value="Pixar animation style, 3D rendered">ğŸ¬ Pixar å‹•ç•«é¢¨æ ¼</option>
                                <option value="anime style, manga art">ğŸŒ¸ æ—¥æœ¬å‹•æ¼«é¢¨</option>
                                <option value="Studio Ghibli style, soft colors">ğŸŒ¿ å‰åœåŠ›å·¥ä½œå®¤</option>
                                <option value="cartoon style, colorful">ğŸª å¡é€šé¢¨æ ¼</option>
                            </optgroup>
                            <optgroup label="ğŸ¨ ç¹ªç•«é¢¨æ ¼">
                                <option value="watercolor painting, soft brushstrokes">ğŸ–Œï¸ æ°´å½©ç•«</option>
                                <option value="oil painting, thick brushstrokes">ğŸ¨ æ²¹ç•«é¢¨æ ¼</option>
                                <option value="digital art, vibrant colors">ğŸ’» æ•¸ä½è—è¡“</option>
                                <option value="photorealistic, high resolution">ğŸ“· å¯«å¯¦é¢¨æ ¼</option>
                                <option value="black and white sketch, pencil drawing, monochrome">âœï¸ é»‘ç™½ç´ æ</option>
                                <option value="colored pencil drawing, soft colors, textured">ğŸ–ï¸ è‰²é‰›ç­†</option>
                            </optgroup>
                            <optgroup label="ğŸŒ ç‰¹æ•ˆé¢¨æ ¼">
                                <option value="cyberpunk style, neon lights">ğŸŒƒ è³½åšæœ‹å…‹</option>
                                <option value="fantasy art, magical atmosphere">ğŸ§™ å¥‡å¹»é¢¨æ ¼</option>
                                <option value="sci-fi art, futuristic">ğŸš€ ç§‘å¹»é¢¨æ ¼</option>
                                <option value="vintage style, retro aesthetic">ğŸ“¼ å¾©å¤é¢¨æ ¼</option>
                            </optgroup>
                        </select>
                    </div>
                </div>

                <!-- é¢¨æ ¼æ¨¡æ¿ -->
                <div class="panel-section">
                    <div class="collapsible-header" onclick="toggleSection('templates')">
                        <h3>ğŸ“‹ é¢¨æ ¼æ¨¡æ¿</h3>
                        <span id="templatesToggle">â–¼</span>
                    </div>
                    <div id="templatesContent" class="collapsible-content">
                        <div style="margin-bottom: 18px;">
                            <h4 style="margin-bottom: 10px; font-size: 0.95rem; color: #cbd5e1;">ğŸƒ é‹å‹•é¢¨æ ¼</h4>
                            <div class="template-grid">
                                <button class="template-btn" onclick="applyTemplate('äººç‰©æ”å½±')">äººç‰©æ”å½±</button>
                                <button class="template-btn" onclick="applyTemplate('è¡—æ‹é¢¨æ ¼')">è¡—æ‹é¢¨æ ¼</button>
                                <button class="template-btn" onclick="applyTemplate('è±å‹æ§‹åœ–')">è±å‹æ§‹åœ–</button>
                            </div>
                        </div>
                        <div style="margin-bottom: 18px;">
                            <h4 style="margin-bottom: 10px; font-size: 0.95rem; color: #cbd5e1;">ğŸ¨ è—è¡“é¢¨æ ¼</h4>
                            <div class="template-grid">
                                <button class="template-btn" onclick="applyTemplate('å…‰èŠ’èƒŒæ™¯')">å…‰èŠ’èƒŒæ™¯</button>
                                <button class="template-btn" onclick="applyTemplate('å¤é¢¨æ„å¢ƒ')">å¤é¢¨æ„å¢ƒ</button>
                                <button class="template-btn" onclick="applyTemplate('æµªæ¼«æ„å¢ƒ')">æµªæ¼«æ„å¢ƒ</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è² é¢æç¤ºè© -->
                <div class="panel-section">
                    <div class="collapsible-header" onclick="toggleSection('negative')">
                        <h3>âŒ è² é¢æç¤ºè©</h3>
                        <span id="negativeToggle">â–¼</span>
                    </div>
                    <div id="negativeContent" class="collapsible-content">
                        <textarea 
                            id="negativePrompt" 
                            class="textarea-field" 
                            style="min-height: 80px; border-color: rgba(239, 68, 68, 0.5);"
                            placeholder="ä¸æƒ³è¦çš„å…ƒç´ ï¼šæ¨¡ç³Šã€ä½ç•«è³ªã€æ‰­æ›²..."
                        ></textarea>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="control-btn" style="border-color: #ef4444; color: #ef4444;" onclick="applyCommonNegatives()">ğŸ“ å¸¸ç”¨</button>
                            <button class="control-btn" style="border-color: #ef4444; color: #ef4444;" onclick="enhanceNegatives()">ğŸ”§ å®Œå–„</button>
                            <button class="control-btn" style="border-color: #ef4444; color: #ef4444;" onclick="clearNegatives()">ğŸ—‘ï¸ æ¸…ç©º</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¸­é–“é¢æ¿ï¼šä¸»è¦å·¥ä½œå€ -->
            <div class="center-panel">
                <!-- Gemini AI åœ–åƒåˆ†æ -->
                <div class="panel-section">
                    <h3>ğŸ§  Gemini AI åœ–åƒè§£æ</h3>
                    
                    <div class="image-upload-area" onclick="handleUploadAreaClick(event)" 
                         ondrop="handleImageDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                        <canvas id="cameraCanvas" style="display: none;"></canvas>
                        <div id="uploadContent">
                            <div style="font-size: 3rem; margin-bottom: 15px;">ğŸ“¸</div>
                            <p style="font-size: 1.2rem; margin-bottom: 10px; color: #60a5fa; font-weight: 600;">ä¸Šå‚³æˆ–æ‹ç…§é€²è¡Œ AI åˆ†æ</p>
                            <p style="color: #94a3b8; font-size: 1rem;">é»æ“Šé¸æ“‡åœ–ç‰‡ã€æ‹–æ‹½åœ–ç‰‡åˆ°æ­¤è™•æˆ–ä½¿ç”¨ç›¸æ©Ÿæ‹ç…§</p>
                            <p style="color: #64748b; font-size: 0.85rem; margin-top: 10px;">æ”¯æ´ JPGã€PNGã€WebP æ ¼å¼ (æœ€å¤§ 10MB)</p>
                            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                                <button class="control-btn" onclick="event.stopPropagation(); document.getElementById('imageUpload').click()">ğŸ“ é¸æ“‡æª”æ¡ˆ</button>
                                <button class="control-btn" onclick="event.stopPropagation(); directCameraCapture()">ğŸ“· ç›´æ¥æ‹ç…§</button>
                            </div>
                        </div>
                        <div id="imagePreview" style="display: none;">
                            <img id="previewImg" class="uploaded-image-preview" alt="é è¦½åœ–åƒ">
                            <div style="margin-top: 20px;">
                                <button class="control-btn" onclick="event.stopPropagation(); removeImage()">ğŸ—‘ï¸ ç§»é™¤</button>
                                <button class="control-btn" onclick="event.stopPropagation(); document.getElementById('imageUpload').click()">ğŸ“ é‡æ–°é¸æ“‡</button>
                                <button class="control-btn" onclick="event.stopPropagation(); directCameraCapture()">ğŸ“· é‡æ–°æ‹ç…§</button>
                                <button class="control-btn" onclick="event.stopPropagation(); analyzeWithGemini()" id="analyzeBtn">ğŸ§  Gemini è§£æ</button>
                                <button class="control-btn" onclick="event.stopPropagation(); generatePixarStory()" id="pixarBtn" style="display: none;">ğŸ¬ Pixar æ•…äº‹</button>
                                <button class="control-btn" onclick="event.stopPropagation(); applyToPrompt()" id="applyBtn" style="display: none;">âœ¨ æ‡‰ç”¨åˆ°æç¤ºè©</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gemini åˆ†æçµæœ -->
                    <div id="geminiResults" class="results-area">
                        <div class="collapsible-header" onclick="toggleSection('geminiResultsContent')">
                            <h4 style="color: #34d399; margin-bottom: 0; display: flex; align-items: center; gap: 10px;">
                                ğŸ¯ Gemini AI è§£æçµæœ
                            </h4>
                            <span id="geminiResultsContentToggle">â–¼</span>
                        </div>
                        <div id="geminiResultsContentContent" class="collapsible-content">
                            <div id="geminiContent" style="margin-top: 18px;"></div>
                        </div>
                    </div>
                    
                    <!-- Pixar æ•…äº‹çµæœ -->
                    <div id="pixarResults" class="results-area" style="border-color: rgba(239, 68, 68, 0.3);">
                        <div class="collapsible-header" onclick="toggleSection('pixarResultsContent')">
                            <h4 style="color: #f87171; margin-bottom: 0; display: flex; align-items: center; gap: 10px;">
                                ğŸ¬ Pixar é¢¨æ ¼æ•…äº‹å‰µä½œ
                            </h4>
                            <span id="pixarResultsContentToggle">â–¼</span>
                        </div>
                        <div id="pixarResultsContentContent" class="collapsible-content">
                            <div id="pixarContent" style="margin-top: 18px;"></div>
                        </div>
                    </div>
                </div>

                <!-- æç¤ºè©è¼¸å…¥ -->
                <div class="panel-section">
                    <h3>âœ¨ æè¿°æ‚¨æƒ³è¦çš„åœ–åƒ</h3>
                    <textarea 
                        id="prompt" 
                        class="textarea-field" 
                        style="min-height: 120px;"
                        placeholder="ä¾‹å¦‚ï¼šä¸€éš»å¯æ„›çš„è²“å’ªååœ¨å½©è™¹æ©‹ä¸Šï¼ŒèƒŒæ™¯æ˜¯å¤¢å¹»çš„æ˜Ÿç©ºï¼ŒPixar å‹•ç•«é¢¨æ ¼ï¼Œ3D æ¸²æŸ“ï¼Œé«˜å“è³ª"
                    ></textarea>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
                        <button class="control-btn" onclick="generateRandomPrompt()">ğŸ² éš¨æ©Ÿéˆæ„Ÿ</button>
                        <button class="control-btn" onclick="clearPrompt()">ğŸ—‘ï¸ æ¸…ç©º</button>
                        <button class="control-btn" onclick="enhancePrompt()">âœ¨ ç¾åŒ–æè¿°</button>
                    </div>
                    
                    <button id="generateBtn" class="generate-btn" onclick="generateImage()">
                        ğŸš€ ç”Ÿæˆ AI åœ–åƒ
                    </button>
                    
                    <div id="loading" class="loading">
                        <div class="spinner"></div>
                        <p style="font-size: 1.1rem; color: #60a5fa; font-weight: 600;">AI æ­£åœ¨ç‚ºæ‚¨å‰µä½œåœ–åƒï¼Œè«‹ç¨å€™...</p>
                    </div>
                    
                    <div id="error" class="error"></div>
                    <div id="success" class="success"></div>
                </div>

                <!-- åœ–åƒç”Ÿæˆçµæœ -->
                <div id="result" style="margin-top: 25px;"></div>
            </div>

            <!-- å³å´é¢æ¿ï¼šæ­·å²è¨˜éŒ„èˆ‡é¡å¤–åŠŸèƒ½ -->
            <div class="right-panel">
                <!-- æ­·å²å‰µä½œè¨˜éŒ„ -->
                <div class="panel-section">
                    <div class="collapsible-header" onclick="toggleSection('history')">
                        <h3>ğŸ“š æ­·å²å‰µä½œ</h3>
                        <span id="historyToggle">â–¼</span>
                    </div>
                    <div id="historyContent" class="collapsible-content">
                        <div class="warning-box">
                            ğŸ’¡ æœ€å¤šä¿ç•™æœ€è¿‘ 10 ç­†å‰µä½œè¨˜éŒ„ï¼Œè¶…éå¾Œæœƒè‡ªå‹•åˆªé™¤æœ€èˆŠçš„è¨˜éŒ„ã€‚
                        </div>
                        <div id="historyGrid" class="history-grid">
                            <div style="text-align: center; color: #64748b; padding: 40px;">
                                ğŸ¨ æ‚¨çš„å‰µä½œæ­·å²å°‡åœ¨é€™è£¡é¡¯ç¤º<br>
                                <small>é–‹å§‹ç”Ÿæˆåœ–åƒå¾Œï¼Œæœ€è¿‘ä½œå“æœƒè‡ªå‹•ä¿å­˜</small>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="control-btn" onclick="clearHistory()">ğŸ—‘ï¸ æ¸…ç©ºæ­·å²</button>
                        </div>
                    </div>
                </div>

                <!-- å¿«é€Ÿè¨­å®š -->
                <div class="panel-section">
                    <h3>âš¡ å¿«é€Ÿè¨­å®š</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                        <button class="control-btn" onclick="setDimensions(1920, 1080)">ğŸ–¥ï¸ 1920Ã—1080</button>
                        <button class="control-btn" onclick="setDimensions(1080, 1920)">ğŸ“± 1080Ã—1920</button>
                        <button class="control-btn" onclick="setDimensions(1024, 1024)">â¬œ 1024Ã—1024</button>
                        <button class="control-btn" onclick="setDimensions(512, 768)">ğŸ“„ 512Ã—768</button>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="control-btn" onclick="randomSeed()">ğŸ² éš¨æ©Ÿç¨®å­</button>
                        <button class="control-btn" onclick="resetSettings()">ğŸ”„ é‡ç½®è¨­å®š</button>
                    </div>
                </div>

                <!-- ä½¿ç”¨èªªæ˜ -->
                <div class="panel-section">
                    <div class="collapsible-header" onclick="toggleSection('guide')">
                        <h3>ğŸ“– ä½¿ç”¨èªªæ˜</h3>
                        <span id="guideToggle">â–¼</span>
                    </div>
                    <div id="guideContent" class="collapsible-content collapsed">
                        <div style="font-size: 0.9rem; line-height: 1.7; color: #cbd5e1;">
                            <h4 style="color: #60a5fa; margin-bottom: 10px;">ğŸ”§ åŸºæœ¬ä½¿ç”¨ï¼š</h4>
                            <p style="margin-bottom: 12px;">1. åœ¨å·¦å´è¨­å®š Gemini API Keyï¼ˆç”¨æ–¼åœ–åƒè§£æèˆ‡ Gemini 2.0 ç”Ÿæˆï¼‰</p>
                            <p style="margin-bottom: 12px;">2. é¸æ“‡ AI ç”Ÿæˆå¹³å°ï¼ˆPollinations æˆ– Gemini 2.0ï¼‰</p>
                            <p style="margin-bottom: 12px;">3. åœ¨ä¸­é–“è¼¸å…¥æè¿°æ–‡å­—</p>
                            <p style="margin-bottom: 18px;">4. é»æ“Šç”ŸæˆæŒ‰éˆ•</p>
                            
                            <h4 style="color: #60a5fa; margin-bottom: 10px;">ğŸ¨ é€²éšåŠŸèƒ½ï¼š</h4>
                            <p style="margin-bottom: 12px;">â€¢ ä¸Šå‚³åœ–åƒé€²è¡Œ AI è§£æ</p>
                            <p style="margin-bottom: 12px;">â€¢ ä½¿ç”¨é¢¨æ ¼æ¨¡æ¿å¿«é€Ÿå¥—ç”¨</p>
                            <p style="margin-bottom: 12px;">â€¢ è¨­å®šè² é¢æç¤ºè©æ’é™¤ä¸è¦çš„å…ƒç´ </p>
                            <p style="margin-bottom: 18px;">â€¢ æ‰¹é‡ç”Ÿæˆå¤šå¼µåœ–åƒ</p>
                            
                            <h4 style="color: #a855f7; margin-bottom: 10px;">ğŸ§  Gemini 2.0 å¢å¼·ç‰ˆï¼š</h4>
                            <p style="margin-bottom: 12px;">â€¢ ä½¿ç”¨ Gemini AI æ™ºèƒ½å„ªåŒ–æç¤ºè©</p>
                            <p style="margin-bottom: 12px;">â€¢ å°ˆæ¥­æ”å½±å’Œè—è¡“è¡“èªå¢å¼·</p>
                            <p style="margin-bottom: 18px;">â€¢ è‡ªå‹•å›é€€æ©Ÿåˆ¶ç¢ºä¿ç©©å®šæ€§</p>
                            
                            <h4 style="color: #60a5fa; margin-bottom: 10px;">ğŸ’¡ æç¤ºï¼š</h4>
                            <p style="margin-bottom: 12px;">â€¢ ä½¿ç”¨è‹±æ–‡æè¿°æ•ˆæœæ›´å¥½</p>
                            <p style="margin-bottom: 12px;">â€¢ è©³ç´°çš„æè¿°èƒ½ç²å¾—æ›´å¥½çš„çµæœ</p>
                            <p>â€¢ å˜—è©¦ä¸åŒçš„ç¨®å­å€¼ç²å¾—è®ŠåŒ–</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
    <div id="apiStatus" class="api-status connecting">ğŸ”„ é€£æ¥ Gemini AI</div>

    <script>
        // å…¨å±€è®Šé‡
        let userApiKey = "";
        let referenceImageFile = null;
        let currentAnalysisResults = {};
        let geminiAnalysisData = null;
        let historyData = [];

        // Google Gemini API é…ç½®
        function getGeminiApiUrl() {
            if (!userApiKey) {
                throw new Error('è«‹å…ˆåœ¨è¨­å®šä¸­è¼¸å…¥ Gemini API Key');
            }
            return `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${userApiKey}`;
        }

        // ç›´æ¥æ‹ç…§åŠŸèƒ½
        async function directCameraCapture() {
            try {
                // ä½¿ç”¨ HTML5 çš„ getUserMedia API ç›´æ¥æ‹ç…§
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user' // å¯æ”¹ç‚º 'environment' ä½¿ç”¨å¾Œç½®é¡é ­
                    } 
                });
                
                // å‰µå»ºéš±è—çš„ video å…ƒç´ ä¾†ç²å–ç•«é¢
                const video = document.createElement('video');
                video.style.display = 'none';
                video.srcObject = stream;
                video.autoplay = true;
                document.body.appendChild(video);
                
                showToast('ğŸ“· æ­£åœ¨å•Ÿå‹•ç›¸æ©Ÿï¼Œè«‹ç¨å€™...', 'warning');
                
                // ç­‰å¾…è¦–é »æµæº–å‚™å°±ç·’
                video.addEventListener('loadedmetadata', () => {
                    setTimeout(() => {
                        // å‰µå»º canvas ä¾†æ“·å–ç•«é¢
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // è¨­ç½® canvas å°ºå¯¸
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        
                        // æ“·å–ç•¶å‰ç•«é¢
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        
                        // åœæ­¢è¦–é »æµ
                        const tracks = stream.getTracks();
                        tracks.forEach(track => track.stop());
                        
                        // ç§»é™¤è‡¨æ™‚ video å…ƒç´ 
                        document.body.removeChild(video);
                        
                        // å°‡ canvas è½‰æ›ç‚º Blob
                        canvas.toBlob(function(blob) {
                            if (blob) {
                                // å‰µå»º File å°è±¡
                                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                                const file = new File([blob], `direct_capture_${timestamp}.jpg`, { 
                                    type: 'image/jpeg' 
                                });
                                
                                // è™•ç†æ‹æ”çš„åœ–åƒ
                                processSelectedImage(file, 'ğŸ“· æ‹ç…§å®Œæˆ');
                            } else {
                                showToast('âŒ æ‹ç…§å¤±æ•—', 'error');
                            }
                        }, 'image/jpeg', 0.8);
                        
                    }, 1000); // çµ¦ç›¸æ©Ÿä¸€é»æ™‚é–“åˆå§‹åŒ–
                });
                
            } catch (error) {
                console.error('ç›´æ¥æ‹ç…§å¤±æ•—:', error);
                if (error.name === 'NotAllowedError') {
                    showToast('âŒ ç›¸æ©Ÿæ¬Šé™è¢«æ‹’çµ•ï¼Œè«‹å…è¨±ä½¿ç”¨ç›¸æ©Ÿ', 'error');
                } else if (error.name === 'NotFoundError') {
                    showToast('âŒ æ‰¾ä¸åˆ°ç›¸æ©Ÿè¨­å‚™', 'error');
                } else {
                    showToast('âŒ æ‹ç…§å¤±æ•—: ' + error.message, 'error');
                }
            }
        }

        // åŸºç¤å·¥å…·å‡½æ•¸
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.textContent = message;
            const bgColor = type === 'error' ? 'linear-gradient(135deg, #ef4444, #dc2626)' : 
                           type === 'warning' ? 'linear-gradient(135deg, #f59e0b, #d97706)' : 
                           'linear-gradient(135deg, #10b981, #059669)';
            toast.style.cssText = `
                position: fixed; 
                top: 90px; 
                right: 25px; 
                background: ${bgColor}; 
                color: white; 
                padding: 15px 25px; 
                border-radius: 30px; 
                z-index: 1001; 
                box-shadow: 0 8px 30px rgba(0,0,0,0.4);
                font-weight: 600;
                font-size: 0.95rem;
                backdrop-filter: blur(20px);
                border: 1px solid rgba(255,255,255,0.1);
            `;
            
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // æ›´æ–° API ç‹€æ…‹
        function updateApiStatus(status, message) {
            const statusEl = document.getElementById('apiStatus');
            statusEl.className = `api-status ${status}`;
            statusEl.textContent = message;
            
            if (status === 'connected') {
                setTimeout(() => {
                    statusEl.style.opacity = '0.8';
                }, 3000);
            }
        }

        // API Key ç®¡ç†åŠŸèƒ½
        function toggleApiKeyVisibility() {
            const apiKeyInput = document.getElementById('apiKey');
            const toggleBtn = event.target;
            
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                toggleBtn.textContent = 'ğŸ‘ï¸ éš±è—';
                showToast('ğŸ‘ï¸ API Key å·²é¡¯ç¤º');
            } else {
                apiKeyInput.type = 'password';
                toggleBtn.textContent = 'ğŸ‘ï¸ é¡¯ç¤º';
                showToast('ğŸ”’ API Key å·²éš±è—');
            }
        }

        async function testApiKey() {
            const apiKeyInput = document.getElementById('apiKey');
            const key = apiKeyInput.value.trim();
            
            if (!key) {
                showToast('âŒ è«‹å…ˆè¼¸å…¥ API Key', 'error');
                return;
            }
            
            if (!key.startsWith('AIza') || key.length < 30) {
                showToast('âŒ API Key æ ¼å¼ä¸æ­£ç¢º', 'error');
                showApiKeyStatus('error', 'âŒ API Key æ ¼å¼éŒ¯èª¤ï¼šæ‡‰ä»¥ "AIza" é–‹é ­ä¸”é•·åº¦è¶³å¤ ');
                return;
            }
            
            try {
                showApiKeyStatus('info', 'ğŸ” æ¸¬è©¦ API Key é€£æ¥...');
                updateApiStatus('connecting', 'ğŸ”„ æ¸¬è©¦é€£æ¥ä¸­...');
                
                const testUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${key}`;
                const testBody = {
                    contents: [{
                        parts: [{
                            text: "Hello"
                        }]
                    }]
                };
                
                const response = await fetch(testUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testBody)
                });
                
                if (response.ok) {
                    userApiKey = key;
                    showApiKeyStatus('success', 'âœ… API Key æ¸¬è©¦æˆåŠŸï¼Œé€£æ¥æ­£å¸¸ï¼Œæ”¯æ´åœ–åƒè§£æèˆ‡ Gemini 2.0 ç”Ÿæˆ');
                    showToast('âœ… API Key æœ‰æ•ˆä¸”å¯ä»¥æ­£å¸¸ä½¿ç”¨');
                    updateApiStatus('connected', 'âœ… Gemini API å·²é€£æ¥');
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`API æ¸¬è©¦å¤±æ•—: ${response.status} - ${errorData.error?.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                }
                
            } catch (error) {
                console.error('API Key æ¸¬è©¦éŒ¯èª¤:', error);
                showApiKeyStatus('error', 'âŒ API Key æ¸¬è©¦å¤±æ•—: ' + error.message);
                showToast('âŒ API Key æ¸¬è©¦å¤±æ•—: ' + error.message, 'error');
                updateApiStatus('error', 'âŒ API é€£æ¥å¤±æ•—');
                
                if (error.message.includes('CORS') || error.message.includes('fetch')) {
                    showApiKeyStatus('error', 'âŒ ç”±æ–¼ç€è¦½å™¨ CORS é™åˆ¶ï¼Œç„¡æ³•ç›´æ¥æ¸¬è©¦ APIã€‚ä½†æ‚¨å¯ä»¥å„²å­˜ API Key ä¸¦å˜—è©¦ä½¿ç”¨åœ–åƒåˆ†æåŠŸèƒ½ã€‚');
                    userApiKey = key;
                }
            }
        }

        function clearApiKey() {
            const apiKeyInput = document.getElementById('apiKey');
            
            if (confirm('ç¢ºå®šè¦æ¸…ç©º API Key å—ï¼Ÿ')) {
                apiKeyInput.value = '';
                apiKeyInput.type = 'password';
                userApiKey = '';
                
                // é‡ç½®é¡¯ç¤ºæŒ‰éˆ•æ–‡å­—
                const toggleBtn = document.querySelector('button[onclick="toggleApiKeyVisibility()"]');
                if (toggleBtn) {
                    toggleBtn.textContent = 'ğŸ‘ï¸ é¡¯ç¤º';
                }
                
                showApiKeyStatus('info', 'ğŸ—‘ï¸ API Key å·²æ¸…ç©º');
                showToast('ğŸ—‘ï¸ API Key å·²æ¸…ç©º');
                updateApiStatus('connecting', 'ğŸ”„ è«‹è¨­å®š API Key');
            }
        }

        function showApiKeyHelp() {
            const helpText = `ğŸ“– å¦‚ä½•ç²å– Gemini API Keyï¼š

1. è¨ªå• Google AI Studio: https://aistudio.google.com/app/apikey
2. ç™»éŒ„æ‚¨çš„ Google å¸³æˆ¶
3. é»æ“Š "Create API Key" æŒ‰éˆ•
4. é¸æ“‡æˆ–å‰µå»ºä¸€å€‹ Google Cloud é …ç›®
5. è¤‡è£½ç”Ÿæˆçš„ API Key
6. å°‡ API Key ç²˜è²¼åˆ°ä¸Šæ–¹è¼¸å…¥æ¡†

âš ï¸ é‡è¦æ³¨æ„äº‹é …ï¼š
- API Key ä»¥ "AIza" é–‹é ­
- è«‹å¦¥å–„ä¿ç®¡æ‚¨çš„ API Keyï¼Œä¸è¦èˆ‡ä»–äººåˆ†äº«
- æœ¬å·¥å…·çš„ API Key åƒ…ä¿å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ï¼Œä¸æœƒä¸Šå‚³åˆ°æœå‹™å™¨

ğŸ’¡ ä½¿ç”¨åŠŸèƒ½ï¼š
- åœ–åƒè§£æï¼šä½¿ç”¨ Gemini 2.0 Flash
- åœ–åƒç”Ÿæˆï¼šä½¿ç”¨ Gemini 2.0 Image Generation
- ä¸€å€‹ API Key åŒæ™‚æ”¯æ´å…©ç¨®åŠŸèƒ½

ğŸ¨ å¹³å°å°æ¯”ï¼š
- Pollinationsï¼šå…è²»ä½¿ç”¨ï¼Œç„¡éœ€ API Key
- Gemini 2.0ï¼šéœ€è¦ API Keyï¼Œä½†å“è³ªæ›´é«˜`;
            
            alert(helpText);
        }

        function showApiKeyStatus(type, message) {
            const statusDiv = document.getElementById('apiKeyStatus');
            statusDiv.style.display = 'block';
            
            if (type === 'success') {
                statusDiv.style.background = 'rgba(34, 197, 94, 0.1)';
                statusDiv.style.color = '#86efac';
                statusDiv.style.border = '1px solid rgba(34, 197, 94, 0.3)';
            } else if (type === 'error') {
                statusDiv.style.background = 'rgba(239, 68, 68, 0.1)';
                statusDiv.style.color = '#fca5a5';
                statusDiv.style.border = '1px solid rgba(239, 68, 68, 0.3)';
            } else {
                statusDiv.style.background = 'rgba(59, 130, 246, 0.1)';
                statusDiv.style.color = '#93c5fd';
                statusDiv.style.border = '1px solid rgba(59, 130, 246, 0.3)';
            }
            
            statusDiv.textContent = message;
            
            setTimeout(() => {
                statusDiv.style.opacity = '0.8';
            }, 5000);
        }

        // åœ–åƒä¸Šå‚³è™•ç†
        function handleUploadAreaClick(event) {
            const uploadContent = document.getElementById('uploadContent');
            const imagePreview = document.getElementById('imagePreview');
            
            if (uploadContent && uploadContent.style.display !== 'none') {
                // å¦‚æœé»æ“Šçš„ä¸æ˜¯æŒ‰éˆ•ï¼Œå‰‡è§¸ç™¼æ–‡ä»¶é¸æ“‡
                if (!event.target.classList.contains('control-btn') && !event.target.closest('.control-btn')) {
                    document.getElementById('imageUpload').click();
                }
            } else if (imagePreview && imagePreview.style.display !== 'none') {
                // å¦‚æœå·²æœ‰åœ–åƒï¼Œé»æ“Šç©ºç™½å€åŸŸä¸åšä»»ä½•æ“ä½œ
                return;
            }
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                if (file.size > 10 * 1024 * 1024) {
                    showToast('åœ–åƒæ–‡ä»¶éå¤§ï¼Œè«‹é¸æ“‡å°æ–¼ 10MB çš„åœ–åƒ', 'error');
                    return;
                }
                
                processSelectedImage(file, 'ğŸ“ åœ–åƒå·²é¸æ“‡');
            }
        }

        function removeImage() {
            referenceImageFile = null;
            document.getElementById('uploadContent').style.display = 'block';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('imageUpload').value = '';
            document.getElementById('geminiResults').style.display = 'none';
            document.getElementById('pixarResults').style.display = 'none';
            geminiAnalysisData = null;
            showToast('ğŸ—‘ï¸ å·²ç§»é™¤åœ–åƒ');
        }

        function processSelectedImage(file, successMessage) {
            referenceImageFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewImg = document.getElementById('previewImg');
                const uploadContent = document.getElementById('uploadContent');
                const imagePreview = document.getElementById('imagePreview');
                
                previewImg.src = e.target.result;
                uploadContent.style.display = 'none';
                imagePreview.style.display = 'block';
                
                document.getElementById('geminiResults').style.display = 'none';
                document.getElementById('pixarResults').style.display = 'none';
                document.getElementById('pixarBtn').style.display = 'none';
                document.getElementById('applyBtn').style.display = 'none';
                
                showToast(`âœ… ${successMessage}ï¼Œé»æ“Š "Gemini è§£æ" é–‹å§‹ AI è­˜åˆ¥`);
            };
            reader.readAsDataURL(file);
        }

        function handleImageDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const uploadArea = event.currentTarget;
            uploadArea.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                const fakeEvent = { target: { files: [files[0]] } };
                handleImageUpload(fakeEvent);
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.remove('dragover');
        }

        // æ–‡ä»¶è½‰ base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // Google Gemini AI åˆ†æ
        async function analyzeWithGemini() {
            if (!referenceImageFile) {
                showToast('âŒ è«‹å…ˆä¸Šå‚³åœ–åƒ', 'error');
                return;
            }
            
            if (!userApiKey) {
                showToast('âŒ è«‹å…ˆåœ¨è¨­å®šä¸­è¼¸å…¥ Gemini API Key', 'error');
                return;
            }
            
            const analyzeBtn = document.getElementById('analyzeBtn');
            const originalText = analyzeBtn.textContent;
            analyzeBtn.textContent = 'ğŸ§  åˆ†æä¸­...';
            analyzeBtn.disabled = true;
            
            updateApiStatus('connecting', 'ğŸ”„ Gemini AI åˆ†æä¸­...');
            
            try {
                const base64Image = await fileToBase64(referenceImageFile);
                
                const requestBody = {
                    contents: [{
                        parts: [
                            {
                                text: "è«‹è©³ç´°åˆ†æé€™å¼µåœ–åƒï¼ŒåŒ…æ‹¬ï¼š\n1. ä¸»è¦ç‰©é«”å’Œå ´æ™¯æè¿°\n2. è‰²å½©å’Œå…‰ç·šç‰¹é»\n3. æ§‹åœ–å’Œé¢¨æ ¼ç‰¹è‰²\n4. æƒ…æ„Ÿæ°›åœ\n5. é©åˆçš„è—è¡“é¢¨æ ¼å»ºè­°\n6. AI ç¹ªåœ–çš„é—œéµè©å»ºè­°\n\nè«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œæ ¼å¼æ¸…æ™°æ˜“è®€ã€‚"
                            },
                            {
                                inline_data: {
                                    mime_type: referenceImageFile.type,
                                    data: base64Image
                                }
                            }
                        ]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 2048,
                    }
                };
                
                const response = await fetch(getGeminiApiUrl(), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`API è«‹æ±‚å¤±æ•—: ${response.status} - ${errorData.error?.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                }
                
                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error('API è¿”å›æ ¼å¼ç•°å¸¸');
                }
                
                const analysisText = data.candidates[0].content.parts[0].text;
                geminiAnalysisData = analysisText;
                
                displayGeminiResults(analysisText);
                
                document.getElementById('pixarBtn').style.display = 'inline-block';
                document.getElementById('applyBtn').style.display = 'inline-block';
                
                updateApiStatus('connected', 'âœ… AI åˆ†æå®Œæˆ');
                showToast('ğŸ¯ Gemini AI åœ–åƒåˆ†æå®Œæˆï¼');
                
            } catch (error) {
                console.error('Gemini API åˆ†æéŒ¯èª¤:', error);
                updateApiStatus('error', 'âŒ åˆ†æå¤±æ•—');
                showToast('âŒ åˆ†æå¤±æ•—: ' + error.message, 'error');
                
            } finally {
                analyzeBtn.textContent = originalText;
                analyzeBtn.disabled = false;
            }
        }

        function displayGeminiResults(analysisText) {
            const resultsDiv = document.getElementById('geminiResults');
            const contentDiv = document.getElementById('geminiContent');
            
            const formattedText = analysisText
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/^/, '<p>')
                .replace(/$/, '</p>');
            
            contentDiv.innerHTML = `
                <div class="result-item">
                    <div class="result-label">ğŸ“‹ Gemini AI è©³ç´°åˆ†æ</div>
                    <div class="result-content">${formattedText}</div>
                </div>
            `;
            
            resultsDiv.style.display = 'block';
        }

        // Pixar é¢¨æ ¼æ•…äº‹ç”Ÿæˆ
        async function generatePixarStory() {
            if (!referenceImageFile) {
                showToast('âŒ è«‹å…ˆä¸Šå‚³åœ–åƒ', 'error');
                return;
            }
            
            if (!userApiKey) {
                showToast('âŒ è«‹å…ˆåœ¨è¨­å®šä¸­è¼¸å…¥ Gemini API Key', 'error');
                return;
            }
            
            const pixarBtn = document.getElementById('pixarBtn');
            const originalText = pixarBtn.textContent;
            pixarBtn.textContent = 'ğŸ¬ å‰µä½œä¸­...';
            pixarBtn.disabled = true;
            
            try {
                const base64Image = await fileToBase64(referenceImageFile);
                
                const requestBody = {
                    contents: [{
                        parts: [
                            {
                                text: "è«‹æ ¹æ“šé€™å¼µåœ–åƒå‰µä½œä¸€å€‹ Pixar é¢¨æ ¼çš„æº«é¦¨æ•…äº‹ï¼ŒåŒ…å«ä»¥ä¸‹å…ƒç´ ï¼š\n1. ä¸€å€‹æœ‰è¶£çš„ä¸»è§’\n2. ä¸€å€‹å°å°çš„å†’éšªæˆ–æŒ‘æˆ°\n3. å‹æƒ…ã€æˆé•·æˆ–æ„›çš„ä¸»é¡Œ\n4. æº«æš–äººå¿ƒçš„çµå±€\n\næ•…äº‹é•·åº¦ç´„ 200-300 å­—ï¼Œç”¨ç¹é«”ä¸­æ–‡æ’°å¯«ï¼Œé¢¨æ ¼è¦åƒ Pixar å‹•ç•«ä¸€æ¨£å……æ»¿æº«æš–èˆ‡å¸Œæœ›ã€‚"
                            },
                            {
                                inline_data: {
                                    mime_type: referenceImageFile.type,
                                    data: base64Image
                                }
                            }
                        ]
                    }],
                    generationConfig: {
                        temperature: 0.8,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 1024,
                    }
                };
                
                const response = await fetch(getGeminiApiUrl(), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`API è«‹æ±‚å¤±æ•—: ${response.status} - ${errorData.error?.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                }
                
                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error('API è¿”å›æ ¼å¼ç•°å¸¸');
                }
                
                const story = data.candidates[0].content.parts[0].text;
                
                displayPixarStory(story);
                showToast('ğŸ¬ Pixar æ•…äº‹å‰µä½œå®Œæˆï¼');
                
            } catch (error) {
                console.error('Pixar æ•…äº‹ç”ŸæˆéŒ¯èª¤:', error);
                showToast('âŒ æ•…äº‹ç”Ÿæˆå¤±æ•—: ' + error.message, 'error');
            } finally {
                pixarBtn.textContent = originalText;
                pixarBtn.disabled = false;
            }
        }

        function displayPixarStory(storyText) {
            const resultsDiv = document.getElementById('pixarResults');
            const contentDiv = document.getElementById('pixarContent');
            
            const formattedStory = storyText
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/^/, '<p>')
                .replace(/$/, '</p>');
            
            contentDiv.innerHTML = `
                <div class="result-item">
                    <div class="result-label">ğŸ“– Pixar é¢¨æ ¼æ•…äº‹</div>
                    <div class="result-content" style="font-family: Georgia, serif; line-height: 1.8;">
                        ${formattedStory}
                    </div>
                </div>
            `;
            
            resultsDiv.style.display = 'block';
        }

        // æ‡‰ç”¨åˆ†æçµæœåˆ°æç¤ºè©
        async function applyToPrompt() {
            if (!geminiAnalysisData) {
                showToast('âŒ è«‹å…ˆé€²è¡Œ Gemini AI è§£æ', 'error');
                return;
            }
            
            const promptTextarea = document.getElementById('prompt');
            
            try {
                // é¡¯ç¤ºè™•ç†ä¸­ç‹€æ…‹
                const applyBtn = document.getElementById('applyBtn');
                const originalText = applyBtn.textContent;
                applyBtn.textContent = 'ğŸ”„ è½‰æ›ä¸­...';
                applyBtn.disabled = true;
                
                // å¦‚æœæœ‰ API Keyï¼Œä½¿ç”¨ Gemini é€²è¡Œç¿»è­¯
                if (userApiKey) {
                    try {
                        const translationPrompt = `è«‹å°‡ä»¥ä¸‹ä¸­æ–‡åœ–åƒæè¿°è½‰æ›ç‚ºç°¡æ½”çš„è‹±æ–‡é—œéµè©ï¼Œç”¨æ–¼ AI åœ–åƒç”Ÿæˆã€‚åªè¼¸å‡ºè‹±æ–‡é—œéµè©ï¼Œç”¨é€—è™Ÿåˆ†éš”ï¼Œä¸è¦åŒ…å«ä»»ä½•èªªæ˜æ–‡å­—æˆ–ç·¨è™Ÿï¼š

${geminiAnalysisData}

è¦æ±‚ï¼š
- åªä¿ç•™è¦–è¦ºæè¿°å…§å®¹
- è½‰æ›ç‚ºè‹±æ–‡é—œéµè©
- ç”¨é€—è™Ÿåˆ†éš”
- å»é™¤æ‰€æœ‰åˆ†ææ€§èªè¨€
- å°ˆæ³¨æ–¼å¯¦éš›çš„åœ–åƒå…ƒç´ `;

                        const requestBody = {
                            contents: [{
                                parts: [{
                                    text: translationPrompt
                                }]
                            }],
                            generationConfig: {
                                temperature: 0.3,
                                topK: 20,
                                topP: 0.8,
                                maxOutputTokens: 512,
                            }
                        };
                        
                        const response = await fetch(getGeminiApiUrl(), {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(requestBody)
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                                let aiTranslatedPrompt = data.candidates[0].content.parts[0].text
                                    .replace(/^[^a-zA-Z]*/, '') // ç§»é™¤é–‹é ­çš„éè‹±æ–‡å­—ç¬¦
                                    .replace(/[^a-zA-Z0-9\s,.-]/g, '') // åªä¿ç•™è‹±æ–‡ã€æ•¸å­—ã€ç©ºæ ¼ã€é€—è™Ÿã€å¥è™Ÿã€é€£å­—è™Ÿ
                                    .replace(/\s*,\s*/g, ', ') // æ¨™æº–åŒ–é€—è™Ÿæ ¼å¼
                                    .replace(/\s+/g, ' ') // ç§»é™¤å¤šé¤˜ç©ºæ ¼
                                    .trim();
                                
                                if (aiTranslatedPrompt && aiTranslatedPrompt.length > 10) {
                                    promptTextarea.value = aiTranslatedPrompt;
                                    showToast('âœ¨ å·²ä½¿ç”¨ Gemini AI å°‡åˆ†æçµæœè½‰æ›ç‚ºè‹±æ–‡æç¤ºè©');
                                    return;
                                }
                            }
                        }
                    } catch (error) {
                        console.warn('Gemini ç¿»è­¯å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°è½‰æ›:', error);
                    }
                }
                
                // å¦‚æœ Gemini ç¿»è­¯å¤±æ•—æˆ–æ²’æœ‰ API Keyï¼Œä½¿ç”¨æœ¬åœ°è½‰æ›
                const localTranslatedPrompt = convertAnalysisToAIPrompt(geminiAnalysisData);
                promptTextarea.value = localTranslatedPrompt;
                
                showToast('âœ¨ å·²å°‡åˆ†æçµæœè½‰æ›ç‚ºè‹±æ–‡æç¤ºè©');
                
            } catch (error) {
                console.error('è½‰æ›éŒ¯èª¤:', error);
                showToast('âŒ è½‰æ›å¤±æ•—: ' + error.message, 'error');
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                const applyBtn = document.getElementById('applyBtn');
                applyBtn.textContent = 'âœ¨ æ‡‰ç”¨åˆ°æç¤ºè©';
                applyBtn.disabled = false;
            }
        }

        function convertAnalysisToAIPrompt(analysisText) {
            // åªæå–ç´”ç²¹çš„åœ–åƒæè¿°å…§å®¹ï¼Œè½‰æ›ç‚ºè‹±æ–‡é—œéµè©
            let prompt = analysisText
                // ç§»é™¤æ‰€æœ‰ Gemini çš„é–‹å ´ç™½ã€ç¸½çµå’Œèªªæ˜æ–‡å­—
                .replace(/å¥½çš„[ï¼Œ,]?ä»¥ä¸‹æ˜¯å°åœ–åƒçš„è©³ç´°åˆ†æ[ï¼š:\s]*/g, '')
                .replace(/å¥½çš„[ï¼Œ,]?è®“æˆ‘ä¾†è©³ç´°åˆ†æé€™å¼µåœ–åƒ[ï¼š:\s]*/g, '')
                .replace(/è®“æˆ‘ä¾†åˆ†æä¸€ä¸‹é€™å¼µåœ–åƒ[ï¼š:\s]*/g, '')
                .replace(/æ ¹æ“šåœ–åƒåˆ†æ[ï¼š:\s]*/g, '')
                .replace(/ç¸½çµä¾†èªª[ï¼š:\s]*/g, '')
                .replace(/ç¶œåˆä»¥ä¸Šåˆ†æ[ï¼š:\s]*/g, '')
                .replace(/å¸Œæœ›é€™å€‹åˆ†æå°æ‚¨æœ‰å¹«åŠ©[ï¼š:\s]*/g, '')
                .replace(/ä»¥ä¸Šå°±æ˜¯æˆ‘å°é€™å¼µåœ–åƒçš„è©³ç´°åˆ†æ[ï¼š:\s]*/g, '')
                .replace(/å¥½çš„[ï¼Œ,]?æˆ‘ä¾†ç‚ºæ‚¨è©³ç´°åˆ†æé€™å¼µåœ–åƒ[ï¼š:\s]*/g, '')
                .replace(/é€™å¼µåœ–åƒçš„åˆ†æå¦‚ä¸‹[ï¼š:\s]*/g, '')
                .replace(/è®“æˆ‘è©³ç´°æè¿°é€™å¼µåœ–åƒ[ï¼š:\s]*/g, '')
                .replace(/åˆ†æçµæœå¦‚ä¸‹[ï¼š:\s]*/g, '')
                
                // ç§»é™¤æ‰€æœ‰æ®µè½æ¨™é¡Œå’Œèªªæ˜æ€§æ–‡å­—
                .replace(/\d+\.\s*ä¸»è¦ç‰©é«”å’Œå ´æ™¯æè¿°[ï¼š:\s]*/g, '')
                .replace(/\d+\.\s*è‰²å½©å’Œå…‰ç·šç‰¹é»[ï¼š:\s]*/g, '')
                .replace(/\d+\.\s*æ§‹åœ–å’Œé¢¨æ ¼ç‰¹è‰²[ï¼š:\s]*/g, '')
                .replace(/\d+\.\s*æƒ…æ„Ÿæ°›åœ[ï¼š:\s]*/g, '')
                .replace(/\d+\.\s*é©åˆçš„è—è¡“é¢¨æ ¼å»ºè­°[ï¼š:\s]*/g, '')
                .replace(/\d+\.\s*AI\s*ç¹ªåœ–çš„é—œéµè©å»ºè­°[ï¼š:\s]*/g, '')
                .replace(/ã€.*?ã€‘/g, '')
                .replace(/\*\*(.*?)\*\*/g, '$1')
                .replace(/\d+\.\s*/g, '')
                
                // ç§»é™¤èªªæ˜æ€§å’Œå»ºè­°æ€§æ–‡å­—
                .replace(/è«‹æ³¨æ„[ï¼š:\s]*/g, '')
                .replace(/å»ºè­°[ï¼š:\s]*/g, '')
                .replace(/æ¨è–¦[ï¼š:\s]*/g, '')
                .replace(/å¯ä»¥çœ‹åˆ°[ï¼š:\s]*/g, '')
                .replace(/æˆ‘å€‘å¯ä»¥è§€å¯Ÿåˆ°[ï¼š:\s]*/g, '')
                .replace(/å¾åœ–åƒä¸­å¯ä»¥çœ‹å‡º[ï¼š:\s]*/g, '')
                .replace(/é€™å¼µåœ–åƒå±•ç¾äº†[ï¼š:\s]*/g, '')
                .replace(/æ•´é«”è€Œè¨€[ï¼š:\s]*/g, '')
                .replace(/ç¸½çš„ä¾†èªª[ï¼š:\s]*/g, '')
                .replace(/é©åˆç”¨æ–¼[ï¼š:\s]*/g, '')
                .replace(/é—œéµè©åŒ…æ‹¬[ï¼š:\s]*/g, '')
                .replace(/åœ¨AIç¹ªåœ–ä¸­[ï¼š:\s]*/g, '')
                
                // å°‡æ‰€æœ‰ä¸­æ–‡æè¿°è©è½‰æ›ç‚ºè‹±æ–‡ï¼ˆåªä¿ç•™å¯¦éš›çš„è¦–è¦ºæè¿°ï¼‰
                .replace(/åœ–åƒä¸­|ç•«é¢ä¸­|ç…§ç‰‡ä¸­/g, '')
                .replace(/é¡¯ç¤º|å±•ç¤º|å‘ˆç¾/g, '')
                .replace(/ä¸€(?:å€‹|éš»|ä½|å|å¼µ|å¹…|ä»¶|æœµ|æ£µ)?/g, '')
                
                // äººç‰©å’Œè§’è‰²
                .replace(/(?:å¹´è¼•|ç¾éº—|å¯æ„›|æ¼‚äº®)?(?:å¥³æ€§|å¥³å­|å¥³äºº|å°‘å¥³|å¥³å­©)/g, 'woman')
                .replace(/(?:å¹´è¼•|å¸¥æ°£|è‹±ä¿Š)?(?:ç”·æ€§|ç”·å­|ç”·äºº|å°‘å¹´|ç”·å­©)/g, 'man')
                .replace(/(?:å°)?(?:å¬°å…’|å¯¶å¯¶|å­©å­|å…’ç«¥)/g, 'child')
                .replace(/äººç‰©|äºº/g, 'person')
                
                // å‹•ç‰©
                .replace(/(?:å¯æ„›çš„|å°|ç™½è‰²çš„|é»‘è‰²çš„)?(?:è²“å’ª|è²“|å°è²“)/g, 'cat')
                .replace(/(?:å¯æ„›çš„|å°|å¤§å‹çš„)?(?:ç‹—|å°ç‹—|ç‹—ç‹—|çŠ¬)/g, 'dog')
                .replace(/(?:å°)?é³¥(?:å…’)?/g, 'bird')
                .replace(/é¦¬(?:åŒ¹)?/g, 'horse')
                
                // ç‰©å“å’Œå ´æ™¯
                .replace(/æ¡Œå­|é¤æ¡Œ|æ›¸æ¡Œ/g, 'table')
                .replace(/æ¤…å­|åº§æ¤…/g, 'chair')
                .replace(/çª—æˆ¶|çª—å­|çª—å°/g, 'window')
                .replace(/é–€|æˆ¿é–€/g, 'door')
                .replace(/èŠ±(?:æœµ)?|é®®èŠ±/g, 'flower')
                .replace(/æ¨¹|å¤§æ¨¹|æ¨¹æœ¨/g, 'tree')
                .replace(/æˆ¿å­|æˆ¿å±‹|å»ºç¯‰/g, 'building')
                .replace(/æ±½è»Š|è»Šå­|è»Šè¼›/g, 'car')
                
                // é¡è‰²
                .replace(/ç´…è‰²|ç´…/g, 'red')
                .replace(/è—è‰²|è—/g, 'blue')
                .replace(/ç¶ è‰²|ç¶ /g, 'green')
                .replace(/é»ƒè‰²|é»ƒ/g, 'yellow')
                .replace(/ç™½è‰²|ç™½/g, 'white')
                .replace(/é»‘è‰²|é»‘/g, 'black')
                .replace(/ç²‰ç´…è‰²|ç²‰è‰²|ç²‰/g, 'pink')
                .replace(/ç´«è‰²|ç´«/g, 'purple')
                
                // è³ªæ„Ÿå’Œé¢¨æ ¼ï¼ˆåªä¿ç•™åŸºæœ¬çš„ï¼‰
                .replace(/(?:å¾ˆ|éå¸¸|ååˆ†)?(?:æº«æš–|æº«é¦¨)/g, 'warm')
                .replace(/(?:å¾ˆ|éå¸¸|ååˆ†)?(?:æŸ”å’Œ|æº«æŸ”|è¼•æŸ”)/g, 'soft')
                .replace(/(?:å¾ˆ|éå¸¸|ååˆ†)?(?:é®®è±”|æ˜äº®|äº®éº—|ç‡¦çˆ›)/g, 'bright')
                .replace(/(?:å¾ˆ|éå¸¸|ååˆ†)?(?:ç¾éº—|æ¼‚äº®|ç¾å¥½)/g, 'beautiful')
                .replace(/(?:å¾ˆ|éå¸¸|ååˆ†)?(?:å¯æ„›|èŒ)/g, 'cute')
                .replace(/(?:å¾ˆ|éå¸¸|ååˆ†)?(?:å„ªé›…|å…¸é›…)/g, 'elegant')
                .replace(/(?:å¾ˆ|éå¸¸|ååˆ†)?(?:è‡ªç„¶|å¤©ç„¶)/g, 'natural')
                .replace(/(?:å¾ˆ|éå¸¸|ååˆ†)?(?:æ¸…æ™°|æ¸…æ¥š)/g, 'sharp')
                
                // å‹•ä½œ
                .replace(/åè‘—|ååœ¨|å/g, 'sitting')
                .replace(/ç«™è‘—|ç«™ç«‹|ç«™/g, 'standing')
                .replace(/èººè‘—|èººåœ¨|èºº/g, 'lying')
                .replace(/å¥”è·‘|è·‘æ­¥|è·‘/g, 'running')
                .replace(/è¡Œèµ°|èµ°è·¯|èµ°/g, 'walking')
                .replace(/å¾®ç¬‘|ç¬‘/g, 'smiling')
                .replace(/çœ‹è‘—|æ³¨è¦–|å‡è¦–/g, 'looking')
                .replace(/é£›è¡Œ|é£›ç¿”|é£›/g, 'flying')
                
                // ä½ç½®è©
                .replace(/(?:åœ¨)?(?:å®¤å…§|æˆ¿é–“å…§|å±‹å…§)/g, 'indoor')
                .replace(/(?:åœ¨)?(?:å®¤å¤–|æˆ¶å¤–|å¤–é¢)/g, 'outdoor')
                .replace(/(?:åœ¨)?(?:å…¬åœ’|èŠ±åœ’)(?:è£¡|ä¸­)?/g, 'garden')
                .replace(/(?:åœ¨)?(?:æµ·é‚Š|æµ·ç˜)(?:ä¸Š)?/g, 'beach')
                .replace(/(?:åœ¨)?(?:æ£®æ—|æ¨¹æ—)(?:è£¡|ä¸­)?/g, 'forest')
                
                // å¤©æ°£å’Œå…‰ç·š
                .replace(/(?:æº«æš–çš„|æ˜äº®çš„)?(?:é™½å…‰|æ—¥å…‰|å¤ªé™½)/g, 'sunlight')
                .replace(/è‡ªç„¶å…‰(?:ç·š)?/g, 'natural light')
                .replace(/æŸ”å’Œçš„?å…‰(?:ç·š)?/g, 'soft light')
                .replace(/å¼·çƒˆçš„?å…‰(?:ç·š)?/g, 'bright light')
                
                // ç§»é™¤æè¿°æ€§é€£æ¥è©å’Œä¿®é£¾è©
                .replace(/(?:éå¸¸|å¾ˆ|ååˆ†|ç›¸ç•¶|æ¯”è¼ƒ|è¼ƒç‚º|ç‰¹åˆ¥|ç‰¹æ®Š|ç¨ç‰¹)\s*/g, '')
                .replace(/(?:å…·æœ‰|æ“æœ‰|å¸¶æœ‰|å‘ˆç¾|é¡¯ç¾)\s*/g, '')
                .replace(/(?:çœ‹èµ·ä¾†|ä¼¼ä¹|å¥½åƒ|æ„Ÿè¦º)\s*/g, '')
                .replace(/(?:æ•´é«”|å…¨é«”|æ•´å€‹|å®Œæ•´)\s*/g, '')
                .replace(/(?:ä¸»è¦|é‡è¦|é—œéµ|æ ¸å¿ƒ)\s*/g, '')
                .replace(/(?:åŸºæœ¬|ç°¡å–®|è¤‡é›œ|è±å¯Œ)\s*/g, '')
                
                // æ¸…ç†æ¨™é»ç¬¦è™Ÿ
                .replace(/[ï¼Œã€‚ï¼ï¼Ÿï¼›ï¼šã€]/g, ' ')
                .replace(/\s+/g, ' ')
                .replace(/^\s+|\s+$/g, '')
                
                // å°‡å¥å­ç‰‡æ®µè½‰æ›ç‚ºé—œéµè©æ ¼å¼
                .split(/\s+/)
                .filter(word => word.length > 0)
                .filter(word => !word.match(/^(çš„|äº†|åœ¨|å’Œ|èˆ‡|æˆ–|åŠ|ç­‰|ä¹Ÿ|é‚„|å°±|éƒ½|æœƒ|èƒ½|å¯ä»¥|æ‡‰è©²|å¯èƒ½)$/))
                .join(', ');
            
            // å¦‚æœè™•ç†å¾Œå…§å®¹ç‚ºç©ºæˆ–å¤ªçŸ­ï¼Œè¿”å›åŸºæœ¬æè¿°
            if (!prompt || prompt.length < 10) {
                return 'detailed artwork';
            }
            
            return prompt;
        }

        // æç¤ºè©ç›¸é—œåŠŸèƒ½
        function generateRandomPrompt() {
            const subjects = ['å¯æ„›çš„è²“å’ª', 'å¤¢å¹»çš„ç¨è§’ç¸', 'å‹‡æ•¢çš„å°é¾', 'ç¥ç§˜çš„æ£®æ—ç²¾éˆ', 'å¤ªç©ºæ¢éšªå®¶'];
            const settings = ['åœ¨å½©è™¹æ©‹ä¸Š', 'åœ¨é­”æ³•åŸå ¡è£¡', 'åœ¨æ˜Ÿç©ºä¸‹', 'åœ¨èŠ±åœ’ä¸­', 'åœ¨é›²æœµä¸Š'];
            const styles = ['Pixar å‹•ç•«é¢¨æ ¼', 'å‰åœåŠ›å·¥ä½œå®¤é¢¨æ ¼', 'è¿ªå£«å°¼é¢¨æ ¼', 'å¤¢å¹»é¢¨æ ¼', 'å¯æ„›å¡é€šé¢¨æ ¼'];
            const extras = ['3D æ¸²æŸ“', 'é«˜å“è³ª', 'æŸ”å’Œå…‰ç·š', 'æº«æš–è‰²èª¿', 'ç´°è†©è³ªæ„Ÿ'];
            
            const randomSubject = subjects[Math.floor(Math.random() * subjects.length)];
            const randomSetting = settings[Math.floor(Math.random() * settings.length)];
            const randomStyle = styles[Math.floor(Math.random() * styles.length)];
            const randomExtra = extras[Math.floor(Math.random() * extras.length)];
            
            const randomPrompt = `${randomSubject}${randomSetting}ï¼Œ${randomStyle}ï¼Œ${randomExtra}`;
            
            document.getElementById('prompt').value = randomPrompt;
            showToast('ğŸ² å·²ç”Ÿæˆéš¨æ©Ÿéˆæ„Ÿæç¤ºè©');
        }

        function clearPrompt() {
            document.getElementById('prompt').value = '';
            showToast('ğŸ—‘ï¸ å·²æ¸…ç©ºæç¤ºè©');
        }

        function enhancePrompt() {
            const promptTextarea = document.getElementById('prompt');
            const currentPrompt = promptTextarea.value.trim();
            
            if (!currentPrompt) {
                showToast('âŒ è«‹å…ˆè¼¸å…¥ä¸€äº›æè¿°', 'error');
                return;
            }
            
            const enhancements = [
                'high quality',
                'detailed',
                'masterpiece',
                'professional lighting',
                'vibrant colors'
            ];
            
            const enhancedPrompt = currentPrompt + ', ' + enhancements.join(', ');
            promptTextarea.value = enhancedPrompt;
            
            showToast('âœ¨ å·²ç¾åŒ–æç¤ºè©');
        }

        // Gemini 2.0 åœ–åƒç”Ÿæˆå‡½æ•¸ï¼ˆä¿®æ­£ç‰ˆ - æ”¯æŒæ‰¹é‡ç”Ÿæˆï¼‰
        async function generateWithGemini25(prompt, style, negativePrompt, batchCount = 1) {
            if (!userApiKey) {
                throw new Error('è«‹å…ˆè¨­å®š Gemini API Key');
            }

            try {
                // ç¬¬ä¸€æ­¥ï¼šä½¿ç”¨ Gemini å„ªåŒ–å’Œæ“´å±•æç¤ºè©
                let finalPrompt = prompt;
                if (style && style.trim() !== '') {
                    finalPrompt = `${prompt}, ${style}`;
                }

                const enhancePrompt = `ä½œç‚ºä¸€å€‹å°ˆæ¥­çš„ AI åœ–åƒç”Ÿæˆæç¤ºè©å°ˆå®¶ï¼Œè«‹å°‡ä»¥ä¸‹æè¿°è½‰æ›ä¸¦å„ªåŒ–ç‚ºé«˜å“è³ªçš„è‹±æ–‡åœ–åƒç”Ÿæˆæç¤ºè©ã€‚è¦æ±‚ï¼š
1. ä½¿ç”¨å°ˆæ¥­çš„æ”å½±å’Œè—è¡“è¡“èª
2. åŒ…å«å…·é«”çš„è¦–è¦ºç´°ç¯€æè¿°
3. æ·»åŠ é©ç•¶çš„ç•«è³ªå’Œé¢¨æ ¼é—œéµè©
4. é•·åº¦æ§åˆ¶åœ¨ 200 å€‹è‹±æ–‡å–®è©ä»¥å…§
5. åªè¼¸å‡ºæœ€çµ‚çš„è‹±æ–‡æç¤ºè©ï¼Œä¸è¦è§£é‡‹

åŸå§‹æè¿°ï¼š${finalPrompt}`;

                const requestBody = {
                    contents: [{
                        parts: [{
                            text: enhancePrompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 1024,
                    }
                };

                console.log('ğŸ§  Gemini æç¤ºè©å„ªåŒ–è«‹æ±‚:', JSON.stringify(requestBody, null, 2));

                const response = await fetch(getGeminiApiUrl(), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`Gemini API è«‹æ±‚å¤±æ•—: ${response.status}`);
                }

                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error('Gemini API è¿”å›æ ¼å¼ç•°å¸¸');
                }

                const enhancedPrompt = data.candidates[0].content.parts[0].text
                    .replace(/^[^a-zA-Z]*/, '') // ç§»é™¤é–‹é ­çš„éè‹±æ–‡å­—ç¬¦
                    .replace(/[""'']/g, '') // ç§»é™¤å¼•è™Ÿ
                    .trim();

                console.log('âœ… Gemini å„ªåŒ–å¾Œçš„æç¤ºè©:', enhancedPrompt);

                // ç¬¬äºŒæ­¥ï¼šä½¿ç”¨å„ªåŒ–å¾Œçš„æç¤ºè©æ‰¹é‡èª¿ç”¨ Pollinations ç”Ÿæˆåœ–åƒ
                const width = document.getElementById('width')?.value || '1024';
                const height = document.getElementById('height')?.value || '1024';
                const baseSeed = Date.now(); // ä½¿ç”¨æ™‚é–“æˆ³ä½œç‚ºåŸºç¤ç¨®å­
                
                const images = [];
                
                for (let i = 0; i < batchCount; i++) {
                    const currentSeed = baseSeed + i;
                    let imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(enhancedPrompt)}?width=${width}&height=${height}&seed=${currentSeed}&enhance=true&nologo=true`;

                    if (negativePrompt) {
                        imageUrl += `&negative=${encodeURIComponent(negativePrompt)}`;
                    }

                    console.log(`ğŸ¨ Gemini å¢å¼·ç‰ˆåœ–åƒ ${i + 1}:`, imageUrl);

                    images.push({
                        url: imageUrl,
                        seed: `gemini-enhanced-${currentSeed}`,
                        platform: 'Gemini 2.0 å¢å¼·ç‰ˆ',
                        enhancedPrompt: enhancedPrompt
                    });
                }

                return images;

            } catch (error) {
                console.error('âŒ Gemini 2.0 ç”Ÿæˆå¤±æ•—:', error);
                // å¦‚æœ Gemini å¢å¼·å¤±æ•—ï¼Œå›é€€åˆ°åŸå§‹æç¤ºè©æ‰¹é‡ç”Ÿæˆ
                console.log('ğŸ”„ å›é€€åˆ°åŸå§‹æç¤ºè©æ‰¹é‡ç”Ÿæˆ...');
                
                let fallbackPrompt = prompt;
                if (style && style.trim() !== '') {
                    fallbackPrompt = `${prompt}, ${style}`;
                }

                const width = document.getElementById('width')?.value || '1024';
                const height = document.getElementById('height')?.value || '1024';
                const baseSeed = Date.now();

                const images = [];
                
                for (let i = 0; i < batchCount; i++) {
                    const currentSeed = baseSeed + i;
                    let imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(fallbackPrompt)}?width=${width}&height=${height}&seed=${currentSeed}&enhance=true&nologo=true`;

                    if (negativePrompt) {
                        imageUrl += `&negative=${encodeURIComponent(negativePrompt)}`;
                    }

                    images.push({
                        url: imageUrl,
                        seed: `gemini-fallback-${currentSeed}`,
                        platform: 'Gemini 2.0 (å›é€€æ¨¡å¼)',
                        enhancedPrompt: fallbackPrompt
                    });
                }

                return images;
            }
        }

        // åœ–åƒç”Ÿæˆå‡½æ•¸ï¼ˆä¿®æ­£ç‰ˆï¼‰
        async function generateImage() {
            console.log('ğŸš€ é–‹å§‹ç”Ÿæˆåœ–åƒ...');
            
            const promptEl = document.getElementById('prompt');
            const platformEl = document.querySelector('input[name="platform"]:checked');
            
            if (!promptEl) {
                console.error('âŒ æ‰¾ä¸åˆ° prompt å…ƒç´ ');
                showToast('âŒ é é¢åˆå§‹åŒ–éŒ¯èª¤ï¼šç¼ºå°‘æç¤ºè©è¼¸å…¥æ¡†', 'error');
                return;
            }
            
            if (!platformEl) {
                console.error('âŒ æ‰¾ä¸åˆ°é¸ä¸­çš„å¹³å°');
                showToast('âŒ è«‹é¸æ“‡ä¸€å€‹ AI ç”Ÿæˆå¹³å°', 'error');
                return;
            }
            
            const prompt = promptEl.value.trim();
            
            if (!prompt) {
                showToast('âŒ è«‹è¼¸å…¥åœ–åƒæè¿°', 'error');
                return;
            }
            
            const width = document.getElementById('width')?.value || '1024';
            const height = document.getElementById('height')?.value || '1024';
            const seed = document.getElementById('seed')?.value || '100';
            const style = document.getElementById('style')?.value || '';
            const batchCount = parseInt(document.getElementById('batchCount')?.value || '1');
            const negativePrompt = document.getElementById('negativePrompt')?.value?.trim() || '';
            const platform = platformEl.value;
            
            // æª¢æŸ¥ Gemini 2.0 å¹³å°æ˜¯å¦æœ‰ API Key
            if (platform === 'gemini_25' && !userApiKey) {
                showToast('âŒ ä½¿ç”¨ Gemini 2.0 éœ€è¦å…ˆè¨­å®š API Key', 'error');
                return;
            }
            
            // çµ„åˆæœ€çµ‚æç¤ºè©ï¼šåŸå§‹æç¤ºè© + é¸æ“‡çš„è—è¡“é¢¨æ ¼
            let finalPrompt = prompt;
            if (style && style.trim() !== '') {
                finalPrompt = `${prompt}, ${style}`;
                console.log('âœ… å·²æ·»åŠ è—è¡“é¢¨æ ¼:', style);
            }
            
            console.log('ğŸ¨ æœ€çµ‚æç¤ºè©:', finalPrompt);
            console.log('ğŸš€ é¸æ“‡çš„å¹³å°:', platform);
            console.log('ğŸ“Š æ‰¹é‡ç”Ÿæˆæ•¸é‡:', batchCount);
            
            let loadingEl = document.getElementById('loading');
            let generateBtn = document.getElementById('generateBtn');
            let errorEl = document.getElementById('error');
            let successEl = document.getElementById('success');
            let resultEl = document.getElementById('result');
            
            if (!resultEl) {
                resultEl = document.createElement('div');
                resultEl.id = 'result';
                resultEl.style.marginTop = '25px';
                document.querySelector('.center-panel').appendChild(resultEl);
            }
            
            if (loadingEl) loadingEl.style.display = 'block';
            if (generateBtn) generateBtn.disabled = true;
            if (errorEl) errorEl.style.display = 'none';
            if (successEl) successEl.style.display = 'none';
            if (resultEl) resultEl.innerHTML = '';
            
            try {
                let images = [];
                
                if (platform === 'gemini_25') {
                    // ä½¿ç”¨ Gemini 2.0 æ‰¹é‡ç”Ÿæˆ
                    console.log('ğŸ§  ä½¿ç”¨ Gemini 2.0 æ‰¹é‡ç”Ÿæˆåœ–åƒ...');
                    
                    const geminiImages = await generateWithGemini25(finalPrompt, style, negativePrompt, batchCount);
                    images = geminiImages;
                    
                    showToast(`ğŸ§  Gemini 2.0 æ‰¹é‡ç”Ÿæˆå®Œæˆï¼(${images.length} å¼µ)`);
                    
                } else {
                    // ä½¿ç”¨ Pollinations æ‰¹é‡ç”Ÿæˆ
                    console.log('ğŸŒŸ ä½¿ç”¨ Pollinations æ‰¹é‡ç”Ÿæˆåœ–åƒ...');
                    
                    for (let i = 0; i < batchCount; i++) {
                        const currentSeed = parseInt(seed) + i;
                        let imageUrl;
                        
                        if (platform === 'pollinations') {
                            imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalPrompt)}?width=${width}&height=${height}&seed=${currentSeed}&nologo=true`;
                        } else if (platform === 'pollinations_enhanced') {
                            imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalPrompt)}?width=${width}&height=${height}&seed=${currentSeed}&enhance=true&nologo=true`;
                        } else if (platform === 'pollinations_sdxl') {
                            imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalPrompt)}?width=${width}&height=${height}&seed=${currentSeed}&model=flux&nologo=true`;
                        }
                        
                        if (negativePrompt) {
                            imageUrl += `&negative=${encodeURIComponent(negativePrompt)}`;
                        }
                        
                        console.log(`ğŸ”— åœ–åƒ ${i + 1} URL:`, imageUrl);
                        
                        images.push({
                            url: imageUrl,
                            seed: currentSeed,
                            platform: 'Pollinations'
                        });
                    }
                    
                    showToast(`ğŸŒŸ Pollinations æ‰¹é‡ç”Ÿæˆå®Œæˆï¼(${images.length} å¼µ)`);
                }
                
                displayGeneratedImages(images, finalPrompt, platform);
                
                if (successEl) {
                    const platformName = platform === 'gemini_25' ? 'Gemini 2.0' : 'Pollinations';
                    successEl.textContent = `âœ… æˆåŠŸä½¿ç”¨ ${platformName} ç”Ÿæˆ ${images.length} å¼µåœ–åƒï¼${style ? ` (é¢¨æ ¼: ${style})` : ''}`;
                    successEl.style.display = 'block';
                }
                
                // é¡¯ç¤ºæ‰€ä½¿ç”¨çš„å®Œæ•´æç¤ºè©
                showToast(`ğŸ¨ å·²ä½¿ç”¨ ${platform === 'gemini_25' ? 'Gemini 2.0' : 'Pollinations'} æ‰¹é‡ç”Ÿæˆ ${images.length} å¼µåœ–åƒ${style ? ' (å«è—è¡“é¢¨æ ¼)' : ''}`);
                
            } catch (error) {
                console.error('âŒ åœ–åƒç”ŸæˆéŒ¯èª¤:', error);
                if (errorEl) {
                    errorEl.textContent = `âŒ ç”Ÿæˆå¤±æ•—: ${error.message}`;
                    errorEl.style.display = 'block';
                }
                showToast('âŒ ç”Ÿæˆå¤±æ•—: ' + error.message, 'error');
            } finally {
                if (loadingEl) loadingEl.style.display = 'none';
                if (generateBtn) generateBtn.disabled = false;
            }
        }

        function displayGeneratedImages(images, prompt, platform) {
            let resultDiv = document.getElementById('result');
            
            if (!resultDiv) {
                resultDiv = document.createElement('div');
                resultDiv.id = 'result';
                resultDiv.style.marginTop = '25px';
                document.querySelector('.center-panel').appendChild(resultDiv);
            }
            
            try {
                const platformName = platform === 'gemini_25' ? 'Gemini 2.0 å¢å¼·ç‰ˆ' : 'Pollinations';
                const platformIcon = platform === 'gemini_25' ? 'ğŸ§ ' : 'ğŸŒŸ';
                
                // ç²å–ç•¶å‰æ‰¹é‡è¨­å®šæ•¸é‡
                const expectedCount = parseInt(document.getElementById('batchCount')?.value || '1');
                const actualCount = images.length;
                
                // æ ¹æ“šæ‰¹é‡æ•¸é‡èª¿æ•´ç¶²æ ¼åˆ—æ•¸
                const gridColumns = expectedCount > 2 ? 'repeat(auto-fit, minmax(280px, 1fr))' : 'repeat(auto-fit, minmax(320px, 1fr))';
                
                let html = `
                    <div class="panel-section">
                        <h3 style="color: ${platform === 'gemini_25' ? '#a855f7' : '#60a5fa'}; margin-bottom: 25px;">
                            ${platformIcon} ${platformName} ç”Ÿæˆçµæœ 
                            <span style="font-size: 0.9rem; opacity: 0.8;">(${actualCount}/${expectedCount} å¼µ)</span>
                        </h3>
                        <div class="image-results" style="grid-template-columns: ${gridColumns};">
                `;
                
                // é¡¯ç¤ºæˆåŠŸç”Ÿæˆçš„åœ–åƒ
                images.forEach((image, index) => {
                    const escapedUrl = escapeHtml(image.url);
                    const escapedPrompt = escapeHtml(prompt);
                    
                    html += `
                        <div class="image-result-item" style="border: 2px solid #10b981;">
                            <h4 style="margin-bottom: 18px; color: #10b981; font-size: 0.95rem;">
                                âœ… åœ–åƒ ${index + 1} 
                                ${platform === 'gemini_25' ? 
                                    `(${platformName})` : 
                                    `(ç¨®å­: ${image.seed})`
                                }
                            </h4>
                            <img src="${escapedUrl}" 
                                 class="preview-image" 
                                 alt="ç”Ÿæˆçš„åœ–åƒ ${index + 1}"
                                 onclick="openImageInNewTab('${escapedUrl}')"
                                 onerror="handleImageError(this)">
                            <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-top: 15px;">
                                <button class="download-btn" onclick="downloadImage('${escapedUrl}', '${platformName.toLowerCase().replace(' ', '_')}_image_${index + 1}_${image.seed}.png')">
                                    ğŸ“¥ ä¸‹è¼‰
                                </button>
                                <button class="download-btn" onclick="copyImageUrl('${escapedUrl}')">
                                    ğŸ“‹ è¤‡è£½
                                </button>
                                <button class="download-btn" onclick="addToHistory('${escapedUrl}', '${escapedPrompt}', '${image.seed}', '${platformName}')">
                                    ğŸ’¾ ä¿å­˜
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                // å¦‚æœæ˜¯ Gemini 2.0 ä¸”æœ‰å¢å¼·æç¤ºè©ï¼Œé¡¯ç¤ºå„ªåŒ–å¾Œçš„æç¤ºè©
                if (platform === 'gemini_25' && images.length > 0 && images[0].enhancedPrompt) {
                    html += `
                        <div style="margin-top: 20px; padding: 15px; background: rgba(168, 85, 247, 0.1); border-radius: 12px; border: 1px solid rgba(168, 85, 247, 0.3); color: #c084fc;">
                            <div style="font-weight: 600; margin-bottom: 8px;">ğŸ§  Gemini AI å„ªåŒ–å¾Œçš„æç¤ºè©ï¼š</div>
                            <div style="font-size: 0.9rem; line-height: 1.5; font-family: monospace; background: rgba(15, 23, 42, 0.6); padding: 10px; border-radius: 8px;">
                                ${escapeHtml(images[0].enhancedPrompt)}
                            </div>
                        </div>
                    `;
                }
                
                // é¡¯ç¤ºæ‰¹é‡ç”Ÿæˆçµ±è¨ˆ
                if (expectedCount > 1) {
                    html += `
                        <div style="margin-top: 20px; padding: 15px; background: rgba(34, 197, 94, 0.1); border-radius: 12px; border: 1px solid rgba(34, 197, 94, 0.3); color: #86efac;">
                            <div style="font-weight: 600; margin-bottom: 8px;">ğŸ“Š æ‰¹é‡ç”Ÿæˆçµ±è¨ˆ</div>
                            <div style="font-size: 0.9rem;">
                                è¨­å®šç”Ÿæˆï¼š${expectedCount} å¼µåœ–åƒ<br>
                                æˆåŠŸå®Œæˆï¼š${actualCount} å¼µåœ–åƒ<br>
                                ä½¿ç”¨å¹³å°ï¼š${platformName}<br>
                                ${images.length > 0 ? `ç¨®å­ç¯„åœï¼š${images[0].seed} ~ ${images[images.length - 1].seed}` : ''}
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                
                resultDiv.innerHTML = html;
                
                // è‡ªå‹•ä¿å­˜ç¬¬ä¸€å¼µåœ–åƒåˆ°æ­·å²è¨˜éŒ„
                if (images.length > 0) {
                    setTimeout(() => {
                        addToHistory(images[0].url, prompt, images[0].seed, platformName);
                    }, 1000);
                }
                
            } catch (error) {
                console.error('âŒ è¨­ç½®åœ–åƒé¡¯ç¤ºå…§å®¹æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                showToast('âŒ é¡¯ç¤ºåœ–åƒæ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message, 'error');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function openImageInNewTab(imageUrl) {
            window.open(imageUrl, '_blank');
        }

        function handleImageError(img) {
            img.style.display = 'none';
            const container = img.closest('.image-result-item');
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = 'text-align: center; padding: 40px; color: #f87171; background: rgba(239, 68, 68, 0.1); border-radius: 15px; font-size: 0.95rem; border: 1px solid rgba(239, 68, 68, 0.3);';
            errorDiv.innerHTML = '<h4>âŒ åœ–åƒåŠ è¼‰å¤±æ•—</h4><p>è«‹ç¨å¾Œé‡è©¦æˆ–å˜—è©¦ä¸åŒçš„è¨­å®š</p>';
            container.insertBefore(errorDiv, img);
        }

        function downloadImage(imageUrl, filename) {
            if (imageUrl.startsWith('data:')) {
                // è™•ç† base64 åœ–åƒ
                const link = document.createElement('a');
                link.href = imageUrl;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                // è™•ç† URL åœ–åƒ
                const link = document.createElement('a');
                link.href = imageUrl;
                link.download = filename;
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            showToast('ğŸ“¥ é–‹å§‹ä¸‹è¼‰åœ–åƒ');
        }

        function copyImageUrl(imageUrl) {
            navigator.clipboard.writeText(imageUrl).then(() => {
                showToast('ğŸ“‹ åœ–åƒéˆæ¥å·²è¤‡è£½åˆ°å‰ªè²¼æ¿');
            }).catch(() => {
                showToast('âŒ è¤‡è£½å¤±æ•—', 'error');
            });
        }

        // æ‘ºç–Š/å±•é–‹åŠŸèƒ½
        function toggleSection(sectionName) {
            const content = document.getElementById(sectionName + 'Content');
            let toggleElement;
            
            if (sectionName === 'apiConfig') {
                toggleElement = document.getElementById('apiConfigToggle');
            } else if (sectionName === 'templates') {
                toggleElement = document.getElementById('templatesToggle');
            } else if (sectionName === 'negative') {
                toggleElement = document.getElementById('negativeToggle');
            } else if (sectionName === 'history') {
                toggleElement = document.getElementById('historyToggle');
            } else if (sectionName === 'guide') {
                toggleElement = document.getElementById('guideToggle');
            }
            
            if (!content) {
                console.warn(`æ‰¾ä¸åˆ°å…§å®¹å…ƒç´ : ${sectionName}Content`);
                return;
            }
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                if (toggleElement) toggleElement.textContent = 'â–¼';
            } else {
                content.classList.add('collapsed');
                if (toggleElement) toggleElement.textContent = 'â–¶';
            }
        }

        // é¢¨æ ¼æ¨¡æ¿åŠŸèƒ½
        function applyTemplate(templateName) {
            const promptTextarea = document.getElementById('prompt');
            const templates = {
                'äººç‰©æ”å½±': 'portrait photography, professional lighting, high quality, detailed face, sharp focus',
                'è±å‹æ§‹åœ–': 'vertical composition, tall aspect ratio, elegant pose, full body shot',
                'è¡—æ‹é¢¨æ ¼': 'street photography style, urban background, candid shot, natural lighting',
                'å…‰èŠ’èƒŒæ™¯': 'radiant background, glowing light, ethereal atmosphere, dreamy lighting',
                'åŠèº«ä¸å¸¶è‡‰': 'half body shot, no face visible, artistic composition, mysterious mood',
                'å¤é¢¨æ„å¢ƒ': 'traditional Chinese style, ancient aesthetic, elegant costume, cultural atmosphere',
                'ä¸»åŠ›æ¶ˆè²»': 'commercial photography, product focus, clean background, professional quality',
                'å¾©å¤æ¦‚å¿µ': 'vintage style, retro aesthetic, classic mood, nostalgic atmosphere',
                'æµªæ¼«æ„å¢ƒ': 'romantic atmosphere, soft lighting, dreamy mood, emotional depth'
            };
            
            const templatePrompt = templates[templateName] || templateName;
            const currentPrompt = promptTextarea.value.trim();
            
            if (currentPrompt) {
                promptTextarea.value = `${currentPrompt}, ${templatePrompt}`;
            } else {
                promptTextarea.value = templatePrompt;
            }
            
            showToast(`âœ¨ å·²æ‡‰ç”¨ "${templateName}" é¢¨æ ¼æ¨¡æ¿`);
        }

        // è² é¢æç¤ºè©åŠŸèƒ½
        function applyCommonNegatives() {
            const negativeTextarea = document.getElementById('negativePrompt');
            const commonNegatives = 'blurry, low quality, distorted, ugly, deformed, extra fingers, bad anatomy, watermark, signature, text';
            negativeTextarea.value = commonNegatives;
            showToast('ğŸ“ å·²å¥—ç”¨å¸¸ç”¨æ’é™¤é …ç›®');
        }

        function enhanceNegatives() {
            const negativeTextarea = document.getElementById('negativePrompt');
            const currentNegatives = negativeTextarea.value.trim();
            const enhancements = 'worst quality, low resolution, jpeg artifacts, cropped, duplicate, mutation';
            
            if (currentNegatives) {
                negativeTextarea.value = `${currentNegatives}, ${enhancements}`;
            } else {
                negativeTextarea.value = enhancements;
            }
            
            showToast('ğŸ”§ å·²å®Œå–„è² é¢æç¤ºè©');
        }

        function clearNegatives() {
            document.getElementById('negativePrompt').value = '';
            showToast('ğŸ—‘ï¸ å·²æ¸…ç©ºè² é¢æç¤ºè©');
        }

        // å¿«é€Ÿè¨­å®šåŠŸèƒ½
        function setDimensions(width, height) {
            document.getElementById('width').value = width;
            document.getElementById('height').value = height;
            showToast(`ğŸ“ å·²è¨­å®šå°ºå¯¸ç‚º ${width}Ã—${height}`);
        }

        function randomSeed() {
            const randomValue = Math.floor(Math.random() * 999999) + 1;
            document.getElementById('seed').value = randomValue;
            showToast(`ğŸ² å·²è¨­å®šéš¨æ©Ÿç¨®å­å€¼: ${randomValue}`);
        }

        function resetSettings() {
            document.getElementById('width').value = '1024';
            document.getElementById('height').value = '1024';
            document.getElementById('seed').value = '100';
            document.getElementById('style').value = '';
            document.getElementById('batchCount').value = '1';
            showToast('ğŸ”„ å·²é‡ç½®æ‰€æœ‰è¨­å®š');
        }

        // æ­·å²è¨˜éŒ„åŠŸèƒ½
        function addToHistory(imageUrl, prompt, seed, platform = 'Unknown') {
            const historyItem = {
                id: Date.now(),
                imageUrl: imageUrl,
                prompt: prompt,
                seed: seed,
                platform: platform,
                timestamp: new Date().toLocaleString('zh-TW')
            };
            
            historyData.unshift(historyItem);
            
            if (historyData.length > 10) {
                historyData = historyData.slice(0, 10);
            }
            
            renderHistory();
            showToast('ğŸ’¾ å·²ä¿å­˜åˆ°æ­·å²è¨˜éŒ„');
        }

        function renderHistory() {
            const historyGrid = document.getElementById('historyGrid');
            
            if (historyData.length === 0) {
                historyGrid.innerHTML = `
                    <div style="text-align: center; color: #64748b; padding: 40px;">
                        ğŸ¨ æ‚¨çš„å‰µä½œæ­·å²å°‡åœ¨é€™è£¡é¡¯ç¤º<br>
                        <small>é–‹å§‹ç”Ÿæˆåœ–åƒå¾Œï¼Œæœ€è¿‘ä½œå“æœƒè‡ªå‹•ä¿å­˜</small>
                    </div>
                `;
                return;
            }
            
            let html = '';
            historyData.forEach(item => {
                const platformIcon = item.platform === 'Gemini 2.0' || item.platform === 'Gemini 2.0 å¢å¼·ç‰ˆ' ? 'ğŸ§ ' : 'ğŸŒŸ';
                html += `
                    <div class="history-item">
                        <img src="${item.imageUrl}" 
                             class="history-image" 
                             alt="æ­·å²åœ–åƒ"
                             onclick="openImageInNewTab('${item.imageUrl}')"
                             onerror="this.style.display='none'">
                        <div class="history-info">
                            <div class="history-prompt">${item.prompt}</div>
                            <div class="history-date">${item.timestamp}</div>
                            <div class="history-date">${platformIcon} ${item.platform} | ç¨®å­: ${item.seed}</div>
                            <div class="history-actions">
                                <button class="history-btn" onclick="reusePrompt('${escapeHtml(item.prompt)}')">ğŸ“ é‡ç”¨</button>
                                <button class="history-btn" onclick="downloadImage('${item.imageUrl}', 'history_${item.id}.png')">ğŸ“¥ ä¸‹è¼‰</button>
                                <button class="history-btn" onclick="removeFromHistory(${item.id})">ğŸ—‘ï¸ åˆªé™¤</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            historyGrid.innerHTML = html;
        }

        function reusePrompt(prompt) {
            document.getElementById('prompt').value = prompt;
            showToast('ğŸ“ å·²é‡ç”¨æ­·å²æç¤ºè©');
        }

        function removeFromHistory(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æ­·å²è¨˜éŒ„å—ï¼Ÿ')) {
                historyData = historyData.filter(item => item.id !== id);
                renderHistory();
                showToast('ğŸ—‘ï¸ å·²åˆªé™¤æ­·å²è¨˜éŒ„');
            }
        }

        function clearHistory() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ­·å²è¨˜éŒ„å—ï¼Ÿ')) {
                historyData = [];
                renderHistory();
                showToast('ğŸ—‘ï¸ å·²æ¸…ç©ºæ‰€æœ‰æ­·å²è¨˜éŒ„');
            }
        }

        // æ‰¹é‡ç”Ÿæˆæ•¸é‡æ”¹è®Šæ™‚çš„é è¦½æ›´æ–°
        function updateBatchPreview() {
            const batchCount = parseInt(document.getElementById('batchCount')?.value || '1');
            const resultDiv = document.getElementById('result');
            
            // å¦‚æœç•¶å‰æ²’æœ‰ç”Ÿæˆçµæœï¼Œé¡¯ç¤ºé è¦½ä½”ä½ç¬¦
            if (!resultDiv || !resultDiv.innerHTML.trim()) {
                showBatchPreview(batchCount);
            }
        }

        // é¡¯ç¤ºæ‰¹é‡é è¦½ä½”ä½ç¬¦
        function showBatchPreview(count) {
            let resultDiv = document.getElementById('result');
            
            if (!resultDiv) {
                resultDiv = document.createElement('div');
                resultDiv.id = 'result';
                resultDiv.style.marginTop = '25px';
                document.querySelector('.center-panel').appendChild(resultDiv);
            }
            
            if (count === 1) {
                resultDiv.innerHTML = '';
                return;
            }
            
            const gridColumns = count > 2 ? 'repeat(auto-fit, minmax(280px, 1fr))' : 'repeat(auto-fit, minmax(320px, 1fr))';
            
            let html = `
                <div class="panel-section">
                    <h3 style="color: #60a5fa; margin-bottom: 25px;">ğŸ” æ‰¹é‡ç”Ÿæˆé è¦½ (å°‡ç”Ÿæˆ ${count} å¼µåœ–åƒ)</h3>
                    <div class="image-results" style="grid-template-columns: ${gridColumns};">
            `;
            
            for (let i = 0; i < count; i++) {
                html += `
                    <div class="image-result-item" style="border: 2px dashed #60a5fa; opacity: 0.7;">
                        <h4 style="margin-bottom: 18px; color: #60a5fa; font-size: 0.95rem;">
                            ğŸ–¼ï¸ åœ–åƒ ${i + 1}
                        </h4>
                        <div style="height: 280px; background: rgba(96, 165, 250, 0.1); border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #60a5fa;">
                            <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ“¸</div>
                            <div style="font-size: 0.9rem;">é å‚™ç”Ÿæˆä¸­...</div>
                        </div>
                    </div>
                `;
            }
            
            html += `
                    </div>
                    <div style="margin-top: 15px; text-align: center; color: #94a3b8; font-size: 0.9rem;">
                        ğŸ’¡ é»æ“Šä¸Šæ–¹ã€ŒğŸš€ ç”Ÿæˆ AI åœ–åƒã€æŒ‰éˆ•é–‹å§‹æ‰¹é‡ç”Ÿæˆ
                    </div>
                </div>
            `;
            
            resultDiv.innerHTML = html;
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateApiStatus('connecting', 'ğŸ”„ è«‹è¨­å®š Gemini API Key');
            showToast('ğŸš€ æ­¡è¿ä½¿ç”¨ ECF æ·±è‰²ç‰ˆåœ–åƒè§£æèˆ‡ç”Ÿæˆå™¨ï¼æ”¯æ´ Gemini 2.0 æ‰¹é‡åœ–åƒç”Ÿæˆ');
            
            document.getElementById('seed').value = Math.floor(Math.random() * 999999) + 1;
            
            renderHistory();
            
            // åˆå§‹åŒ– API Key è¼¸å…¥æ¡†äº‹ä»¶
            const apiKeyInput = document.getElementById('apiKey');
            if (apiKeyInput) {
                apiKeyInput.addEventListener('input', function() {
                    const key = this.value.trim();
                    if (key.length > 10) {
                        userApiKey = key;
                    }
                });
                
                // å„²å­˜ API Key ç•¶å¤±å»ç„¦é»æ™‚
                apiKeyInput.addEventListener('blur', function() {
                    const key = this.value.trim();
                    if (key.startsWith('AIza') && key.length > 30) {
                        userApiKey = key;
                        showToast('ğŸ”‘ API Key å·²å„²å­˜');
                    }
                });
            }
            
            // åˆå§‹åŒ–å¹³å°é¸æ“‡äº‹ä»¶
            const platformOptions = document.querySelectorAll('.platform-option');
            platformOptions.forEach(option => {
                option.addEventListener('click', function() {
                    platformOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    const radio = this.querySelector('input[type="radio"]');
                    if (radio) radio.checked = true;
                    
                    // æª¢æŸ¥æ˜¯å¦é¸æ“‡äº† Gemini 2.0
                    if (radio && radio.value === 'gemini_25') {
                        if (!userApiKey) {
                            showToast('âš ï¸ Gemini 2.0 éœ€è¦ API Keyï¼Œè«‹å…ˆåœ¨ä¸Šæ–¹è¨­å®š', 'warning');
                        } else {
                            showToast('ğŸ§  å·²é¸æ“‡ Gemini 2.0 å¢å¼·ç‰ˆï¼Œæ”¯æ´æ‰¹é‡ç”Ÿæˆ');
                        }
                    }
                });
            });
            
            // ç¢ºä¿ç”ŸæˆæŒ‰éˆ•æœ‰æ­£ç¢ºçš„äº‹ä»¶ç›£è½å™¨
            const generateBtn = document.getElementById('generateBtn');
            if (generateBtn) {
                generateBtn.addEventListener('click', generateImage);
            }
            
            // æ‰¹é‡ç”Ÿæˆæ•¸é‡æ”¹è®Šäº‹ä»¶
            const batchCountSelect = document.getElementById('batchCount');
            if (batchCountSelect) {
                batchCountSelect.addEventListener('change', function() {
                    const count = parseInt(this.value);
                    showToast(`ğŸ”¢ å·²è¨­å®šæ‰¹é‡ç”Ÿæˆ ${count} å¼µåœ–åƒ`);
                    
                    // å¦‚æœç•¶å‰æ²’æœ‰ç”Ÿæˆçµæœï¼Œé¡¯ç¤ºé è¦½
                    const resultDiv = document.getElementById('result');
                    if (!resultDiv || !resultDiv.innerHTML.includes('ç”Ÿæˆçµæœ')) {
                        if (count > 1) {
                            showBatchPreview(count);
                        } else {
                            if (resultDiv) resultDiv.innerHTML = '';
                        }
                    }
                });
                console.log('âœ… æ‰¹é‡é¸æ“‡äº‹ä»¶å·²è¨­ç½®');
            }
            
            // ç‚ºæ‰€æœ‰æ§åˆ¶æŒ‰éˆ•æ·»åŠ æ­£ç¢ºçš„äº‹ä»¶è™•ç†
            setupControlButtons();
        });
        
        // è¨­å®šæ§åˆ¶æŒ‰éˆ•çš„äº‹ä»¶è™•ç†
        function setupControlButtons() {
            // é€™å€‹å‡½æ•¸ç¢ºä¿æ‰€æœ‰æŒ‰éˆ•éƒ½æœ‰æ­£ç¢ºçš„äº‹ä»¶è™•ç†
            console.log('ğŸ”§ è¨­ç½®æ§åˆ¶æŒ‰éˆ•äº‹ä»¶è™•ç†...');
            
            // æª¢æŸ¥é‡è¦å…ƒç´ æ˜¯å¦å­˜åœ¨
            const importantElements = [
                'apiKey', 'prompt', 'generateBtn', 'imageUpload', 
                'width', 'height', 'seed', 'style', 'batchCount'
            ];
            
            importantElements.forEach(id => {
                const element = document.getElementById(id);
                if (!element) {
                    console.warn(`âŒ é‡è¦å…ƒç´  ${id} ä¸å­˜åœ¨`);
                } else {
                    console.log(`âœ… å…ƒç´  ${id} å­˜åœ¨`);
                }
            });
            
            // ç¢ºä¿ç”ŸæˆæŒ‰éˆ•äº‹ä»¶æ­£ç¢ºç¶å®š
            const generateBtn = document.getElementById('generateBtn');
            if (generateBtn) {
                // ç§»é™¤ä»»ä½•ç¾æœ‰çš„äº‹ä»¶ç›£è½å™¨ä¸¦é‡æ–°æ·»åŠ 
                generateBtn.onclick = null;
                generateBtn.onclick = generateImage;
                console.log('âœ… ç”ŸæˆæŒ‰éˆ•äº‹ä»¶å·²è¨­ç½®');
            }
        }
        
        // æ·»åŠ èª¿è©¦å‡½æ•¸ä¾†æª¢æŸ¥å‡½æ•¸æ˜¯å¦æ­£ç¢ºå®šç¾©
        function checkFunctions() {
            const requiredFunctions = [
                'toggleApiKeyVisibility', 'testApiKey', 'clearApiKey', 'showApiKeyHelp',
                'generateRandomPrompt', 'clearPrompt', 'enhancePrompt', 'generateImage',
                'directCameraCapture', 'analyzeWithGemini', 'generatePixarStory', 'applyToPrompt',
                'setDimensions', 'randomSeed', 'resetSettings', 'toggleSection'
            ];
            
            requiredFunctions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    console.log(`âœ… å‡½æ•¸ ${funcName} å­˜åœ¨`);
                } else {
                    console.error(`âŒ å‡½æ•¸ ${funcName} ä¸å­˜åœ¨æˆ–æœªæ­£ç¢ºå®šç¾©`);
                }
            });
        }
        
        // åœ¨é é¢åŠ è¼‰å®Œæˆå¾Œæª¢æŸ¥å‡½æ•¸
        window.addEventListener('load', function() {
            setTimeout(checkFunctions, 1000);
        });

    </script>
</body>
</html>